<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARKASIR PRO V4 - SINGLE FILE PWA</title>
    
    <meta name="theme-color" content="#06b6d4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="ARKASIR V4">
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; }

        .arkasir-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            letter-spacing: 2px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        #scanner-container {
            width: 100%;
            height: 300px;
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            margin-bottom: 1rem;
            background-color: #000;
        }

        #scanner-video-element {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .receipt-preview {
            width: 300px;
            padding: 10px;
            font-size: 10px;
            line-height: 1.3;
            background-color: white;
            color: #1f2937;
        }
        
        /* HACK: Perbaikan cetak struk agar tidak mencetak halaman kosong */
        @media print {
            body > *:not(.print-area) { display: none !important; }
            .print-area {
                display: block;
                position: absolute;
                top: 0;
                left: 0;
                width: 300px;
                margin: 0;
                padding: 0;
                box-shadow: none;
            }
            .receipt-preview {
                width: 100%;
                font-size: 10px;
                line-height: 1.3;
            }
            @page { margin: 0; }
        }
        
        .report-print-area {
            width: 400px;
            padding: 20px;
            font-size: 12px;
            line-height: 1.4;
            background-color: white;
            color: #1f2937;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <div id="app" class="flex flex-col flex-grow max-w-md mx-auto w-full shadow-lg bg-white rounded-t-xl overflow-hidden">

        <header class="p-4 bg-cyan-600 text-white shadow-md flex justify-between items-center">
            <h1 class="text-xl arkasir-title">ARKASIR PRO V4</h1>
            <button onclick="navigate('Settings')" class="text-white hover:text-cyan-200 p-2 rounded-full transition duration-150">
                <span class="text-2xl">‚öôÔ∏è</span>
            </button>
        </header>

        <main id="content-area" class="flex-grow p-4 overflow-y-auto pb-20"></main>

        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white shadow-2xl border-t border-gray-200 z-50">
            <div class="flex justify-around items-center h-16">
                <button onclick="navigate('POS')" class="nav-btn flex flex-col items-center justify-center p-2 text-sm text-gray-500 hover:text-cyan-600 transition duration-150">
                    <span class="text-2xl">üõí</span>
                    <span class="mt-0.5">Kasir</span>
                </button>
                <button onclick="navigate('PettyCash')" class="nav-btn flex flex-col items-center justify-center p-2 text-sm text-gray-500 hover:text-cyan-600 transition duration-150">
                    <span class="text-2xl">üí∞</span>
                    <span class="mt-0.5">Kas Kecil</span>
                </button>
                <button onclick="navigate('Reports')" class="nav-btn flex flex-col items-center justify-center p-2 text-sm text-gray-500 hover:text-cyan-600 transition duration-150">
                    <span class="text-2xl">üìä</span>
                    <span class="mt-0.5">Laporan</span>
                </button>
                <button onclick="navigate('Products')" class="nav-btn flex flex-col items-center justify-center p-2 text-sm text-gray-500 hover:text-cyan-600 transition duration-150">
                    <span class="text-2xl">üì¶</span>
                    <span class="mt-0.5">Produk</span>
                </button>
            </div>
        </nav>

    </div>

    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl m-4 max-w-sm w-full p-6">
            </div>
    </div>

    <div id="print-export-area" class="fixed top-0 left-0 opacity-0 -z-50 print-area"></div>
    <video id="scanner-video-element" class="hidden"></video>

    <script>
        // --- üü¢ Data PWA Manifest (Diencode ke base64 Data URI) ---
        const manifestData = {
          "name": "ARKASIR PRO V4",
          "short_name": "ARKASIR V4",
          "description": "Aplikasi Kasir Mobile Lengkap (PWA)",
          "start_url": "./arkasir_v4_single.html",
          "display": "standalone",
          "background_color": "#ffffff",
          "theme_color": "#06b6d4",
          "icons": [
            {"src": "icon-192x192.png", "sizes": "192x192", "type": "image/png", "purpose": "any maskable"},
            {"src": "icon-512x512.png", "sizes": "512x512", "type": "image/png"}
          ]
        };
        const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
        const manifestUrl = URL.createObjectURL(manifestBlob);
        
        // Tambahkan tag <link rel="manifest"> secara dinamis
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestUrl;
        document.head.appendChild(link);

        // --- üü¢ PWA Service Worker (Diencode ke base64 Data URI) ---
        const serviceWorkerScript = `
            const CACHE_NAME = 'arkasir-v4-cache-v1';
            const urlsToCache = [
              './arkasir_v4_single.html', 
              'icon-192x192.png', 
              // Tambahkan URL CDN jika Anda ingin mencache-nya, tetapi lebih baik tidak untuk file besar
            ];
            
            self.addEventListener('install', event => {
              event.waitUntil(
                caches.open(CACHE_NAME)
                  .then(cache => {
                    console.log('Opened cache');
                    return cache.addAll(urlsToCache).catch(err => {
                        console.error('Caching failed (some files might not be available offline):', err);
                    });
                  })
              );
              self.skipWaiting();
            });

            self.addEventListener('fetch', event => {
              event.respondWith(
                caches.match(event.request)
                  .then(response => {
                    if (response) {
                      return response;
                    }
                    return fetch(event.request);
                  }
                )
              );
            });

            self.addEventListener('activate', event => {
              const cacheWhitelist = [CACHE_NAME];
              event.waitUntil(
                caches.keys().then(cacheNames => {
                  return Promise.all(
                    cacheNames.map(cacheName => {
                      if (cacheWhitelist.indexOf(cacheName) === -1) {
                        return caches.delete(cacheName);
                      }
                    })
                  );
                })
              );
            });
        `;
        const swBlob = new Blob([serviceWorkerScript], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(swBlob);
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register(swUrl)
                    .then(reg => console.log('Service Worker registered successfully with scope: ', reg.scope))
                    .catch(err => console.log('Service Worker registration failed: ', err));
            });
        }
        
        // --- Data & State Management ---
        const DEFAULT_SETTINGS = { storeName: 'TOKO ANDA PRO', cashierName: 'Kasir Utama', address: 'Alamat Toko Anda', logoUrl: '' };
        const DEFAULT_PRODUCTS = [
            { id: 'prod1', name: 'Kopi Susu', price: 18000, cost: 10000, stock: 50, barcode: '12345' },
            { id: 'prod2', name: 'Roti Panggang', price: 15000, cost: 8000, stock: 30, barcode: '67890' },
        ];
        
        window.appState = {
            settings: DEFAULT_SETTINGS,
            products: DEFAULT_PRODUCTS,
            cart: [],
            transactions: [],
            pettyCash: [],
            currentPage: 'POS',
            scanTarget: null, 
            codeReader: null, 
        };

        function loadFromLocalStorage() {
            const storedSettings = localStorage.getItem('arkasir_settings');
            const storedProducts = localStorage.getItem('arkasir_products');
            const storedTransactions = localStorage.getItem('arkasir_transactions');
            const storedPettyCash = localStorage.getItem('arkasir_pettyCash');

            if (storedSettings) window.appState.settings = { ...window.appState.settings, ...JSON.parse(storedSettings) };
            if (storedProducts) window.appState.products = JSON.parse(storedProducts).map(p => ({
                ...p,
                cost: p.cost !== undefined ? p.cost : 0,
                stock: p.stock !== undefined ? p.stock : 0 
            }));
            if (storedTransactions) window.appState.transactions = JSON.parse(storedTransactions);
            if (storedPettyCash) window.appState.pettyCash = JSON.parse(storedPettyCash);
        }

        function saveToLocalStorage() {
            localStorage.setItem('arkasir_settings', JSON.stringify(window.appState.settings));
            localStorage.setItem('arkasir_products', JSON.stringify(window.appState.products));
            localStorage.setItem('arkasir_transactions', JSON.stringify(window.appState.transactions));
            localStorage.setItem('arkasir_pettyCash', JSON.stringify(window.appState.pettyCash));
        }

        loadFromLocalStorage();

        // --- Global Helper Functions ---

        window.navigate = (page) => {
            window.appState.currentPage = page;
            if (window.appState.codeReader) {
                window.appState.codeReader.reset();
                window.appState.codeReader = null;
            }
            renderApp();
        };

        window.formatRupiah = (number) => {
            if (isNaN(number) || number === null) return 'Rp 0';
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
        };
        
        window.formatDate = (timestamp) => {
            return new Date(timestamp).toLocaleDateString('id-ID', { dateStyle: 'short', timeStyle: 'short' });
        }

        window.showModal = (title, contentHtml, showClose = true) => {
            const modalBackdrop = document.getElementById('modal-backdrop');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-cyan-600">${title}</h3>
                    ${showClose ? `<button onclick="window.closeModal()" class="text-gray-400 hover:text-gray-600">
                        <span class="text-xl">‚úï</span>
                    </button>` : ''}
                </div>
                ${contentHtml}
            `;
            modalBackdrop.classList.remove('hidden');
            modalBackdrop.classList.add('flex');
        };

        window.closeModal = () => {
            const modalBackdrop = document.getElementById('modal-backdrop');
            modalBackdrop.classList.add('hidden');
            modalBackdrop.classList.remove('flex');
            
            if (window.appState.codeReader) {
                window.appState.codeReader.reset();
                window.appState.codeReader = null;
            }
        };
        
        window.downloadFile = (dataUrl, filename, mimeType) => {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        
        // --- Barcode Scanning & Handler ---
        window.openBarcodeScanner = (targetPage) => {
            window.showModal('Scan Barcode Cepat (WASM)', `
                <div id="scanner-container">
                    <video id="scanner-video-element" class="w-full h-full"></video>
                </div>
                <p id="scanner-status" class="text-center text-sm text-gray-500 mt-2">Memuat kamera...</p>
                <div class="flex justify-end mt-4">
                    <button onclick="window.closeModal()" class="py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600">
                        Stop Scan
                    </button>
                </div>
            `, false);
            
            window.appState.scanTarget = targetPage;
            setTimeout(window.startZxingScanner, 500);
        };

        window.startZxingScanner = () => {
            const statusElement = document.getElementById('scanner-status');
            const videoElement = document.getElementById('scanner-video-element');
            
            try {
                window.appState.codeReader = new ZXing.BrowserMultiFormatReader();

                window.appState.codeReader.getVideoInputDevices().then((videoInputDevices) => {
                    if (videoInputDevices.length === 0) {
                        statusElement.textContent = 'Tidak ada perangkat kamera ditemukan.';
                        return;
                    }

                    const selectedDeviceId = videoInputDevices.find(
                        device => device.label.toLowerCase().includes('back') || device.label.toLowerCase().includes('environment')
                    )?.deviceId || videoInputDevices[0].deviceId;

                    statusElement.textContent = 'Mencari barcode...';

                    window.appState.codeReader.decodeFromVideoDevice(selectedDeviceId, videoElement, (result, err) => {
                        if (result) {
                            const barcode = result.getText();
                            
                            window.appState.codeReader.reset();
                            window.appState.codeReader = null;
                            window.closeModal();

                            if (window.appState.scanTarget === 'POS') {
                                window.handleScannedBarcodePOS(barcode);
                            } else if (window.appState.scanTarget === 'Products') {
                                window.handleScannedBarcodeProducts(barcode);
                            }
                        }
                    });

                }).catch(err => {
                    statusElement.textContent = 'Gagal memuat kamera. Cek izin browser atau perangkat.';
                });

            } catch (error) {
                statusElement.textContent = 'Gagal menginisialisasi scanner (ZXing).';
            }
        };

        window.handleScannedBarcodePOS = (barcode) => {
            const product = window.appState.products.find(p => p.barcode === barcode);
            
            if (product) {
                window.addToCart(product.id);
                window.showModal('Scan Sukses!', `Produk <b>${product.name}</b> ditambahkan.`);
                setTimeout(() => { window.closeModal(); }, 1000); 
            } else {
                window.showModal('Produk Tidak Ditemukan', `Barcode <b>${barcode}</b> tidak cocok dengan produk manapun.`);
            }
        };

        window.handleScannedBarcodeProducts = (barcode) => {
            const barcodeInput = document.getElementById('product-barcode');
            if (barcodeInput) {
                barcodeInput.value = barcode;
                window.showModal('Barcode Terisi', `Barcode <b>${barcode}</b> berhasil diisi ke form Produk.`);
                setTimeout(() => { window.closeModal(); }, 1500);
            }
        };
        
        window.handleBarcodeScan = (event) => {
            const input = event.target;
            const value = input.value.trim();
            
            if (event.key === 'Enter' && value.length > 0) {
                const product = window.appState.products.find(p => p.barcode === value || p.name.toLowerCase().includes(value.toLowerCase()));
                if (product) {
                    window.addToCart(product.id);
                    input.value = ''; // Clear input
                } else {
                    window.showModal('Produk Tidak Ditemukan', `Kode/Nama <b>${value}</b> tidak cocok.`);
                }
            }
        }

        // --- Logic Halaman POS ---
        window.renderPOS = () => {
            const { products, cart } = window.appState;
            const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);

            const cartHtml = cart.length === 0
                ? '<p class="text-center text-gray-500 pt-10">Keranjang kosong. Tambahkan produk!</p>'
                : cart.map((item) => {
                    const productData = products.find(p => p.id === item.id) || {};
                    const isOutOfStock = productData.stock !== undefined && item.quantity > productData.stock;
                    return `
                        <div class="flex justify-between items-center p-2 border-b last:border-b-0 ${isOutOfStock ? 'bg-red-100' : ''}">
                            <div class="flex-grow">
                                <p class="font-semibold text-gray-800">${item.name}</p>
                                <p class="text-xs text-gray-500">${window.formatRupiah(item.price)} x ${item.quantity} ${isOutOfStock ? `<span class="text-red-600 font-bold">‚ö†Ô∏è Stok Kurang (${productData.stock} tersisa)</span>` : ''}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="font-bold text-cyan-600">${window.formatRupiah(item.price * item.quantity)}</span>
                                <button onclick="window.updateCartQuantity('${item.id}', -1)" class="text-red-500 p-1 rounded-full text-lg">‚ûñ</button>
                                <button onclick="window.updateCartQuantity('${item.id}', 1)" class="text-green-500 p-1 rounded-full text-lg">‚ûï</button>
                                <button onclick="window.removeFromCart('${item.id}')" class="text-red-700 p-1 rounded-full text-lg">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                }).join('');

            const productListHtml = products.filter(p => p.stock > 0).map(product => `
                <button onclick="window.addToCart('${product.id}')" class="bg-white p-3 rounded-lg shadow-sm hover:shadow-md transition duration-150 border border-gray-200 text-left">
                    <p class="font-bold text-gray-800">${product.name}</p>
                    <p class="text-sm text-cyan-600">${window.formatRupiah(product.price)}</p>
                    <p class="text-xs text-gray-500">Stok: ${product.stock}</p>
                </button>
            `).join('');

            const isStockWarning = cart.some(item => {
                const productData = products.find(p => p.id === item.id);
                return productData.stock !== undefined && item.quantity > productData.stock;
            });
            
            const paymentDisabled = cart.length === 0 || isStockWarning;


            return `
                <div class="flex flex-col h-full space-y-4">
                    <h2 class="text-2xl font-extrabold text-gray-800 mb-2">Kasir Cepat</h2>

                    <div class="sticky top-0 bg-white pt-1 pb-4 z-10 border-b border-gray-200">
                        <div class="flex items-center space-x-2">
                            <input type="text" id="barcode-input" onkeyup="window.handleBarcodeScan(event)" placeholder="Ketik Kode/Nama Produk" class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:ring-cyan-500 focus:border-cyan-500">
                            <button onclick="window.openBarcodeScanner('POS')" class="p-3 bg-cyan-600 text-white rounded-r-lg hover:bg-cyan-700 transition duration-150 flex items-center">
                                <span class="text-xl">üì∑ Scan</span>
                            </button>
                        </div>
                        <small class="text-xs text-gray-500 mt-1 block">Tekan Enter untuk mencari cepat.</small>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-4 max-h-40 overflow-y-scroll p-2 bg-gray-50 rounded-lg">
                        ${productListHtml.length > 0 ? productListHtml : '<p class="col-span-2 text-center text-gray-500">Tidak ada produk tersedia/stok habis.</p>'}
                    </div>

                    <div class="flex-grow bg-white border border-gray-200 rounded-lg shadow-inner overflow-y-scroll max-h-80">
                        ${cartHtml}
                    </div>
                    
                    ${isStockWarning ? '<p class="text-red-600 font-bold text-center mt-2 p-2 bg-red-200 rounded-lg">‚ö† Stok barang tidak mencukupi untuk melanjutkan transaksi.</p>' : ''}

                    <div class="sticky bottom-0 bg-white p-4 -mx-4 border-t border-gray-200 shadow-xl">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-xl font-semibold text-gray-600">TOTAL</span>
                            <span class="text-3xl font-extrabold text-cyan-700">${window.formatRupiah(total)}</span>
                        </div>
                        <button onclick="window.processPayment()" ${paymentDisabled ? 'disabled' : ''} class="w-full py-4 bg-cyan-600 text-white font-bold text-lg rounded-xl shadow-lg hover:bg-cyan-700 transition duration-150 disabled:bg-gray-400">
                            Bayar Sekarang
                        </button>
                    </div>
                </div>
            `;
        };
        
        window.addToCart = (productId) => {
            const product = window.appState.products.find(p => p.id === productId);
            if (!product) return;
            
            const existingItem = window.appState.cart.find(item => item.id === productId);
            const currentQuantity = existingItem ? existingItem.quantity : 0;
            
            if (currentQuantity + 1 > (product.stock || Infinity)) {
                 window.showModal('Stok Habis/Kurang', `Stok produk <b>${product.name}</b> hanya tersisa ${product.stock}.`);
                 return;
            }

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                window.appState.cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    cost: product.cost,
                    quantity: 1,
                });
            }
            window.navigate('POS');
        };

        window.updateCartQuantity = (productId, change) => {
            const item = window.appState.cart.find(item => item.id === productId);
            if (!item) return;

            const product = window.appState.products.find(p => p.id === productId);
            const newQuantity = item.quantity + change;
            
            if (change > 0 && newQuantity > (product.stock || Infinity)) {
                 window.showModal('Stok Habis/Kurang', `Stok produk <b>${product.name}</b> hanya tersisa ${product.stock}. Tidak bisa menambah lagi.`);
                 return;
            }

            item.quantity = newQuantity;

            if (item.quantity <= 0) {
                window.removeFromCart(productId);
            } else {
                window.navigate('POS');
            }
        };
        
        window.removeFromCart = (productId) => {
            window.appState.cart = window.appState.cart.filter(item => item.id !== productId);
            window.navigate('POS');
        };
        
        window.processPayment = () => {
            const total = window.appState.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            
            window.showModal('Pembayaran', `
                <p class="text-xl font-bold mb-4">Total: <span class="text-cyan-600">${window.formatRupiah(total)}</span></p>
                <div class="mb-4">
                    <label for="paid-amount" class="block text-sm font-medium text-gray-700">Jumlah Bayar (Rp)</label>
                    <input type="number" id="paid-amount" value="${total}" min="${total}" required oninput="window.calculateChange(${total})" class="mt-1 block w-full p-3 text-lg border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500">
                </div>
                <p class="text-lg font-bold mb-4">Kembalian: <span id="change-display" class="text-green-600">${window.formatRupiah(0)}</span></p>
                <button onclick="window.finalizeTransaction(${total})" class="w-full py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700">
                    Selesaikan Transaksi
                </button>
            `);
            setTimeout(() => document.getElementById('paid-amount')?.focus(), 100);
        };
        
        window.calculateChange = (total) => {
            const paid = parseFloat(document.getElementById('paid-amount').value) || 0;
            const change = paid - total;
            document.getElementById('change-display').textContent = window.formatRupiah(change > 0 ? change : 0);
        };
        
        window.finalizeTransaction = (total) => {
            const paid = parseFloat(document.getElementById('paid-amount').value) || 0;
            const change = paid - total;

            if (paid < total) {
                return window.showModal('Pembayaran Kurang', 'Jumlah pembayaran harus mencukupi total belanja.');
            }
            
            // 1. Update Stok
            let grossProfit = 0;
            const itemsForTransaction = window.appState.cart.map(item => {
                const productInStock = window.appState.products.find(p => p.id === item.id);
                
                if (productInStock) {
                    productInStock.stock -= item.quantity;
                }
                
                const cost = productInStock.cost || 0;
                const itemGrossProfit = (item.price - cost) * item.quantity;
                grossProfit += itemGrossProfit;
                return { ...item, cost: cost, grossProfit: itemGrossProfit };
            });

            // 2. Simpan Transaksi
            const transactionId = 'TRX-' + Date.now().toString().slice(-8);
            const transactionData = {
                items: itemsForTransaction, 
                total: total,
                paid: paid,
                change: change,
                grossProfit: grossProfit, 
                timestamp: Date.now(),
                cashierName: window.appState.settings.cashierName || 'Kasir',
            };
            
            window.appState.transactions.unshift({ id: transactionId, ...transactionData });
            
            // 3. Simpan & Reset
            saveToLocalStorage();
            window.appState.cart = [];
            window.closeModal();
            window.navigate('POS');
            window.showReceiptModal({ id: transactionId, ...transactionData });
        };
        
        window.generateReceiptHtml = (transaction) => {
            if (!transaction || transaction.items.length === 0) return '<p class="text-center">Struk kosong atau tidak valid.</p>';
            
            const { settings } = window.appState;
            const datetime = new Date(transaction.timestamp).toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' });

            // ‚ö†Ô∏è Perbaikan cetak kosong: Pastikan item list ada isinya
            const itemsHtml = transaction.items.map(item => `
                <div class="flex">
                    <span class="w-1/2">${item.name}</span>
                    <span class="w-1/4 text-right">${item.quantity} x</span>
                    <span class="w-1/4 text-right">${window.formatRupiah(item.price * item.quantity)}</span>
                </div>
            `).join('');
            
            if (itemsHtml.trim() === '') return '<p class="text-center">Struk kosong atau tidak valid.</p>';


            return `
                <div class="receipt-preview text-center mx-auto" id="receipt-area-${transaction.id}">
                    ${settings.logoUrl ? `<img src="${settings.logoUrl}" alt="Logo" class="mx-auto w-10 h-10 object-contain mb-1">` : ''}
                    <p class="text-xs font-bold">${settings.storeName}</p>
                    <p class="text-xs">${settings.address}</p>
                    <p class="text-xs mb-2">Kasir: ${transaction.cashierName}</p>
                    <div class="border-t border-b border-dashed border-gray-500 py-1 mb-2">
                        <div class="flex justify-between text-xs">
                            <span>Tgl: ${datetime.split(',')[0]}</span>
                            <span>Jam: ${datetime.split(',')[1]}</span>
                        </div>
                        <p class="text-xs">TRX ID: ${transaction.id}</p>
                    </div>

                    <div class="text-left text-xs mb-2 space-y-0.5">
                        ${itemsHtml}
                    </div>

                    <div class="border-t border-dashed border-gray-500 pt-1 mb-2 text-xs text-right">
                        <div class="flex justify-between font-semibold">
                            <span>TOTAL</span>
                            <span>${window.formatRupiah(transaction.total)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>BAYAR</span>
                            <span>${window.formatRupiah(transaction.paid)}</span>
                        </div>
                        <div class="flex justify-between font-bold">
                            <span>KEMBALIAN</span>
                            <span>${window.formatRupiah(transaction.change)}</span>
                        </div>
                    </div>

                    <p class="text-xs mt-3">*** TERIMA KASIH ***</p>
                </div>
            `;
        };
        
        window.showReceiptModal = (transaction) => {
            const receiptHtml = window.generateReceiptHtml(transaction);

            const contentHtml = `
                <div class="flex flex-col items-center">
                    <p class="text-green-600 font-bold mb-3">Transaksi Selesai!</p>
                    ${receiptHtml}
                    <div class="mt-4 w-full space-y-2">
                        <button onclick="window.printReceiptById('${transaction.id}')" class="w-full py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 flex items-center justify-center space-x-2">
                            <span>üñ®Ô∏è Cetak Struk</span>
                        </button>
                        <button onclick="window.shareReceipt('${transaction.id}')" class="w-full py-2 bg-purple-500 text-white font-semibold rounded-lg hover:bg-purple-600 flex items-center justify-center space-x-2">
                            <span>üì≤ Share (PNG)</span>
                        </button>
                        <button onclick="window.downloadReceiptPng('${transaction.id}')" class="w-full py-2 bg-cyan-500 text-white font-semibold rounded-lg hover:bg-cyan-600 flex items-center justify-center space-x-2">
                            <span>üñºÔ∏è Simpan PNG</span>
                        </button>
                    </div>
                </div>
            `;
            window.showModal('Preview Struk', contentHtml, true);
        };
        
        window.printReceiptById = (transactionId) => {
            const transaction = window.appState.transactions.find(t => t.id === transactionId);
            if (!transaction) return window.showModal('Error', 'Transaksi tidak ditemukan.');
            
            // üü¢ Perbaikan cetak struk kosong: Pastikan area cetak memiliki konten
            const receiptHtml = window.generateReceiptHtml(transaction);
            if (receiptHtml.includes('Struk kosong')) return window.showModal('Gagal Cetak', 'Struk kosong atau tidak valid.');
            
            const printExportArea = document.getElementById('print-export-area');
            printExportArea.innerHTML = receiptHtml;

            // Pastikan ID unik di dalam area cetak sebelum print
            const receiptArea = document.getElementById(`receipt-area-${transactionId}`);
            if (receiptArea) receiptArea.id = 'receipt-area-temp';

            window.print();

            // Kembalikan ke keadaan semula setelah print selesai (penting untuk PWA & mobile)
            setTimeout(() => {
                if (document.getElementById('receipt-area-temp')) {
                    document.getElementById('receipt-area-temp').id = `receipt-area-${transactionId}`;
                }
                printExportArea.innerHTML = ''; 
            }, 500);
            
            window.closeModal(); // Tutup modal preview
        };
        
        window.downloadReceiptPng = (transactionId) => {
            const transaction = window.appState.transactions.find(t => t.id === transactionId);
            if (!transaction) return window.showModal('Error', 'Transaksi tidak ditemukan.');
            
            window.closeModal(); 

            const receiptHtml = window.generateReceiptHtml(transaction);
            const printExportArea = document.getElementById('print-export-area');
            printExportArea.innerHTML = receiptHtml;
            const receiptArea = document.getElementById(`receipt-area-${transactionId}`);

            if (receiptHtml.includes('Struk kosong')) return window.showModal('Gagal Export', 'Struk kosong atau tidak valid.');

            html2canvas(receiptArea, { scale: 3, useCORS: true }).then(canvas => {
                printExportArea.innerHTML = ''; // Hapus dari area tersembunyi
                const dataUrl = canvas.toDataURL('image/png');
                window.downloadFile(dataUrl, `struk_kasir_${transactionId}.png`, 'image/png');
                window.showModal('Sukses', `Struk #${transactionId} berhasil diunduh (PNG).`);
            });
        };
        
        window.shareReceipt = (transactionId) => {
            const transaction = window.appState.transactions.find(t => t.id === transactionId);
            if (!transaction) return window.showModal('Error', 'Transaksi tidak ditemukan.');
            
            window.closeModal(); 

            const receiptHtml = window.generateReceiptHtml(transaction);
            if (receiptHtml.includes('Struk kosong')) return window.showModal('Gagal Share', 'Struk kosong atau tidak valid.');
            
            const printExportArea = document.getElementById('print-export-area');
            printExportArea.innerHTML = receiptHtml;
            const receiptArea = document.getElementById(`receipt-area-${transactionId}`);

            html2canvas(receiptArea, { scale: 3, useCORS: true }).then(canvas => {
                printExportArea.innerHTML = ''; 
                
                if (navigator.share) {
                    canvas.toBlob((blob) => {
                        const file = new File([blob], `struk_kasir_${transactionId}.png`, { type: 'image/png' });
                        navigator.share({
                            title: `Struk ARKASIR - ${transaction.id}`,
                            text: `Berikut struk transaksi dari ${window.appState.settings.storeName} (${window.formatRupiah(transaction.total)})`,
                            files: [file],
                        })
                        .then(() => console.log('Share successful'))
                        .catch((error) => window.showModal('Error Share', `Gagal share: ${error.message}`));
                    }, 'image/png');
                    
                } else {
                    window.showModal('Share', 'Browser Anda tidak mendukung Web Share API. File akan diunduh sebagai ganti share.');
                    const dataUrl = canvas.toDataURL('image/png');
                    window.downloadFile(dataUrl, `struk_kasir_${transactionId}.png`, 'image/png');
                }
            });
        }
        
        // --- Logic Halaman Produk (Stok, Impor/Ekspor CSV) ---

        window.renderProducts = () => {
            const { products } = window.appState;

            const listHtml = products.map(product => `
                <div class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm border border-gray-200">
                    <div>
                        <p class="font-bold text-gray-800">${product.name}</p>
                        <p class="text-sm text-cyan-600">Jual: ${window.formatRupiah(product.price)} | Beli: ${window.formatRupiah(product.cost)}</p>
                        <p class="text-xs ${product.stock <= 5 ? 'text-red-500 font-bold' : 'text-gray-500'}">Stok: ${product.stock} ${product.stock <= 5 ? ' (RENDAH)' : ''} | Barcode: ${product.barcode || 'N/A'}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="window.editProduct('${product.id}')" class="text-blue-500 hover:text-blue-700 p-2">
                            ‚úèÔ∏è
                        </button>
                        <button onclick="window.deleteProduct('${product.id}')" class="text-red-500 hover:text-red-700 p-2">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('');

            return `
                <div class="pb-6">
                    <h2 class="text-2xl font-extrabold text-gray-800 mb-4">Manajemen Produk & Stok</h2>
                    <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 mb-6">
                        <h3 id="product-form-title" class="text-xl font-bold text-purple-600 mb-4 flex items-center space-x-2">
                            <span>‚ûï</span> <span class="flex-grow">Tambah Produk Baru</span>
                        </h3>
                        <form id="product-form" onsubmit="window.saveProduct(event)">
                            <input type="hidden" id="product-id" value="">
                            <div class="mb-4">
                                <label for="product-name" class="block text-sm font-medium text-gray-700">Nama Produk</label>
                                <input type="text" id="product-name" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                            </div>
                            <div class="mb-4">
                                <label for="product-price" class="block text-sm font-medium text-gray-700">Harga Jual (Rp)</label>
                                <input type="number" id="product-price" required min="1" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                            </div>
                            <div class="mb-4">
                                <label for="product-cost" class="block text-sm font-medium text-gray-700">Harga Beli/Modal (Rp)</label>
                                <input type="number" id="product-cost" required min="0" value="0" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                            </div>
                             <div class="mb-4">
                                <label for="product-stock" class="block text-sm font-medium text-gray-700">Stok Awal</label>
                                <input type="number" id="product-stock" required min="0" value="0" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                            </div>
                            <div class="mb-4">
                                <label for="product-barcode" class="block text-sm font-medium text-gray-700">Barcode/Kode Angka (Unik)</label>
                                <div class="flex">
                                    <input type="text" id="product-barcode" placeholder="Opsional: Kode angka unik" class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:ring-purple-500 focus:border-purple-500">
                                    <button type="button" onclick="window.openBarcodeScanner('Products')" class="p-3 bg-purple-600 text-white rounded-r-lg hover:bg-purple-700 transition duration-150 flex items-center">
                                        <span class="text-xl">üì∑</span>
                                    </button>
                                </div>
                            </div>
                            <button type="submit" id="product-submit-btn" class="w-full py-3 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition duration-150">
                                Simpan Produk
                            </button>
                            <button type="button" onclick="window.resetProductForm()" class="w-full py-2 mt-2 text-purple-600 font-semibold rounded-lg border border-purple-600 hover:bg-purple-50 transition duration-150 hidden" id="product-cancel-btn">
                                Batal Edit
                            </button>
                        </form>
                    </div>
                    
                    <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 mb-6">
                        <h3 class="text-xl font-bold text-gray-700 mb-4 flex items-center space-x-2">
                            <span>üì¶</span> <span>Impor/Ekspor Produk</span>
                        </h3>
                        <div class="flex space-x-2 mb-3">
                            <button onclick="window.exportToCsv('products')" class="flex-1 py-3 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700">
                                üíæ Ekspor CSV
                            </button>
                            <label for="import-products-file" class="flex-1 block py-3 text-center bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 cursor-pointer">
                                ‚¨ÜÔ∏è Impor CSV
                            </label>
                            <input type="file" id="import-products-file" accept=".csv" onchange="window.importProductsCsv(event)" class="hidden">
                        </div>
                        <p class="text-xs text-gray-500">Gunakan format CSV: id,name,price,cost,stock,barcode</p>
                    </div>

                    <div class="mt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-3">Daftar Produk (${products.length} Item)</h3>
                        <div class="space-y-3 max-h-96 overflow-y-scroll p-2 bg-gray-50 rounded-lg border border-gray-200">
                            ${listHtml.length > 0 ? listHtml : '<p class="text-center text-gray-500 p-4">Tidak ada produk.</p>'}
                        </div>
                    </div>
                </div>
            `;
        };
        
        window.saveProduct = (event) => {
            event.preventDefault();
            const id = document.getElementById('product-id').value;
            const name = document.getElementById('product-name').value;
            const price = parseFloat(document.getElementById('product-price').value);
            const cost = parseFloat(document.getElementById('product-cost').value);
            const stock = parseInt(document.getElementById('product-stock').value);
            const barcode = document.getElementById('product-barcode').value.trim();

            if (!name || isNaN(price) || price <= 0 || isNaN(cost) || cost < 0 || isNaN(stock) || stock < 0) return window.showModal('Gagal', 'Semua input wajib diisi dan harus valid.');
            if (price < cost) return window.showModal('Gagal', 'Harga Jual tidak boleh lebih rendah dari Harga Beli.');

            const productData = { name, price, cost, stock, barcode };
            
            if (id) {
                const index = window.appState.products.findIndex(p => p.id === id);
                if (index !== -1) window.appState.products[index] = { id, ...productData };
                window.showModal('Sukses', `Produk <b>${name}</b> berhasil diupdate.`);
            } else {
                const newId = 'PROD-' + Date.now().toString().slice(-8);
                window.appState.products.push({ id: newId, ...productData });
                window.showModal('Sukses', `Produk <b>${name}</b> berhasil ditambahkan.`);
            }
            
            saveToLocalStorage();
            document.getElementById('product-form').reset();
            window.resetProductForm();
            renderApp();
        };
        
        window.editProduct = (id) => {
            const product = window.appState.products.find(p => p.id === id);
            if (!product) return;

            document.getElementById('product-form-title').innerHTML = `<span>‚úèÔ∏è</span> <span class="flex-grow">Edit Produk: ${product.name}</span>`;
            document.getElementById('product-id').value = product.id;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-cost').value = product.cost;
            document.getElementById('product-stock').value = product.stock;
            document.getElementById('product-barcode').value = product.barcode;
            document.getElementById('product-submit-btn').textContent = 'Update Produk';
            document.getElementById('product-cancel-btn').classList.remove('hidden');
            
            document.getElementById('content-area').scrollTo(0, 0); // Gulir ke atas untuk fokus pada form
        };
        
        window.resetProductForm = () => {
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            document.getElementById('product-form-title').innerHTML = `<span>‚ûï</span> <span class="flex-grow">Tambah Produk Baru</span>`;
            document.getElementById('product-submit-btn').textContent = 'Simpan Produk';
            document.getElementById('product-cancel-btn').classList.add('hidden');
        };
        
        window.deleteProduct = (id) => {
            const product = window.appState.products.find(p => p.id === id);
             if (!confirm(`Yakin ingin menghapus produk ${product.name}?`)) return;
             
             window.appState.products = window.appState.products.filter(p => p.id !== id);
             saveToLocalStorage();
             window.showModal('Sukses', `Produk <b>${product.name}</b> berhasil dihapus.`);
             renderApp();
        };
        
        window.importProductsCsv = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim() !== '');
                    const headers = lines[0].toLowerCase().split(',').map(h => h.trim());
                    
                    if (!headers.includes('name') || !headers.includes('price')) {
                         throw new Error('Header CSV tidak lengkap. Diperlukan: name, price, cost, stock, barcode.');
                    }
                    
                    const importedProducts = [];
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',');
                        if (values.length !== headers.length) continue;

                        const product = {};
                        headers.forEach((header, index) => {
                            let value = values[index].trim().replace(/^"|"$/g, '').replace(/""/g, '"');
                            if (header === 'price' || header === 'cost' || header === 'stock') {
                                product[header] = parseInt(value) || 0;
                            } else {
                                product[header] = value;
                            }
                        });
                        
                        if (!product.id) product.id = 'PROD-' + Date.now().toString().slice(-8) + i;
                        if (product.name && product.price > 0) {
                            importedProducts.push(product);
                        }
                    }
                    
                    window.appState.products = importedProducts; 
                    saveToLocalStorage();
                    
                    window.showModal('Sukses Impor Produk', `${importedProducts.length} produk berhasil diimpor dari CSV.`);
                    renderApp();

                } catch (error) {
                    console.error("Error importing CSV:", error);
                    window.showModal('Error Impor', `Gagal mengimpor CSV: ${error.message}.`);
                }
            };
            reader.readAsText(file);
        };
        
        window.convertToCsv = (data, type) => {
            if (type === 'products') {
                const headers = ['id', 'name', 'price', 'cost', 'stock', 'barcode'];
                const rows = data.map(p => headers.map(h => `"${p[h] || ''}"`).join(','));
                return [headers.join(','), ...rows].join('\n');
            }
            return '';
        };

        window.exportToCsv = (type) => {
            let data;
            let filename;

            if (type === 'products') {
                data = window.appState.products;
                filename = `arkasir_products_${new Date().toISOString().slice(0, 10)}.csv`;
            } else {
                return;
            }

            const csvContent = window.convertToCsv(data, type);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            window.downloadFile(url, filename, 'text/csv');
            window.showModal('Ekspor Sukses', `Data ${type} berhasil diunduh sebagai file CSV.`);
        };


        // --- Logic Halaman PettyCash ---
        window.renderPettyCash = () => {
            const { pettyCash } = window.appState;
            
            const totalIncome = pettyCash.filter(p => p.type === 'income').reduce((sum, p) => sum + p.amount, 0);
            const totalExpense = pettyCash.filter(p => p.type === 'expense').reduce((sum, p) => sum + p.amount, 0);
            const currentBalance = totalIncome - totalExpense;

            const listHtml = pettyCash.map(p => `
                <div class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm border border-gray-200">
                    <div>
                        <p class="font-bold text-gray-800">${p.description}</p>
                        <p class="text-xs text-gray-500">${window.formatDate(p.timestamp)}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="font-bold ${p.type === 'income' ? 'text-green-600' : 'text-red-600'}">${p.type === 'expense' ? '-' : ''}${window.formatRupiah(p.amount)}</span>
                        <button onclick="window.deletePettyCash('${p.id}')" class="text-red-500 hover:text-red-700 p-1">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');

            return `
                <div class="pb-6">
                    <h2 class="text-2xl font-extrabold text-gray-800 mb-4">Manajemen Kas Kecil (Petty Cash)</h2>

                    <div class="bg-cyan-50 p-5 rounded-xl shadow-lg border border-cyan-300 mb-6">
                        <p class="text-sm font-semibold text-gray-600">Saldo Kas Saat Ini</p>
                        <p class="text-4xl font-extrabold text-cyan-700">${window.formatRupiah(currentBalance)}</p>
                    </div>
                    
                    <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 mb-6">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">Catat Transaksi Kas</h3>
                        <form onsubmit="window.addPettyCash(event)">
                            <div class="mb-4">
                                <label for="pc-type" class="block text-sm font-medium text-gray-700">Jenis Transaksi</label>
                                <select id="pc-type" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg">
                                    <option value="expense">Pengeluaran (Biaya Operasional, dll.)</option>
                                    <option value="income">Pemasukan (Modal Tambahan, dll.)</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="pc-amount" class="block text-sm font-medium text-gray-700">Jumlah (Rp)</label>
                                <input type="number" id="pc-amount" required min="1" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                            <div class="mb-4">
                                <label for="pc-description" class="block text-sm font-medium text-gray-700">Deskripsi</label>
                                <input type="text" id="pc-description" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                            <button type="submit" class="w-full py-3 bg-cyan-600 text-white font-semibold rounded-lg hover:bg-cyan-700 transition duration-150">
                                Catat Transaksi
                            </button>
                        </form>
                    </div>

                    <div class="mt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-3">Riwayat Transaksi Kas</h3>
                        <div class="space-y-3 max-h-96 overflow-y-scroll p-2 bg-gray-50 rounded-lg border border-gray-200">
                            ${listHtml.length > 0 ? listHtml : '<p class="text-center text-gray-500 p-4">Tidak ada riwayat kas kecil.</p>'}
                        </div>
                    </div>
                </div>
            `;
        };
        
        window.addPettyCash = (event) => {
            event.preventDefault();
            const type = document.getElementById('pc-type').value;
            const amount = parseFloat(document.getElementById('pc-amount').value);
            const description = document.getElementById('pc-description').value;

            if (isNaN(amount) || amount <= 0) return window.showModal('Gagal', 'Jumlah harus valid.');

            const newPC = {
                id: 'PC-' + Date.now().toString().slice(-8),
                type,
                amount,
                description,
                timestamp: Date.now(),
            };

            window.appState.pettyCash.unshift(newPC);
            saveToLocalStorage();
            document.getElementById('pc-form')?.reset();
            window.showModal('Sukses', `Transaksi Kas (${type === 'income' ? 'Pemasukan' : 'Pengeluaran'}) berhasil dicatat.`);
            renderApp();
        };

        window.deletePettyCash = (id) => {
            if (!confirm('Yakin ingin menghapus transaksi kas ini?')) return;
            window.appState.pettyCash = window.appState.pettyCash.filter(p => p.id !== id);
            saveToLocalStorage();
            renderApp();
        };

        // --- Logic Halaman Laporan (Hapus Transaksi, Analisis Mingguan) ---
        
        window.getWeekStartTimestamp = (date = new Date()) => {
            const d = new Date(date);
            const day = d.getDay() || 7; 
            d.setDate(d.getDate() - (day - 1)); 
            d.setHours(0, 0, 0, 0);
            return d.getTime();
        }

        window.getTodayStartTimestamp = () => {
             const d = new Date();
             d.setHours(0, 0, 0, 0);
             return d.getTime();
        }

        window.getMonthStartTimestamp = () => {
             const d = new Date();
             d.setDate(1);
             d.setHours(0, 0, 0, 0);
             return d.getTime();
        }

        window.generateReport = (transactions, pettyCash, period) => {
            let startTime = 0;
            if (period === 'daily') startTime = window.getTodayStartTimestamp();
            if (period === 'monthly') startTime = window.getMonthStartTimestamp();
            
            const filteredTransactions = transactions.filter(t => t.timestamp >= startTime);
            const filteredPettyCash = pettyCash.filter(p => p.timestamp >= startTime);
            
            const sales = filteredTransactions.reduce((sum, t) => sum + t.total, 0);
            const totalCost = filteredTransactions.reduce((sum, t) => sum + t.items.reduce((s, item) => s + (item.cost * item.quantity), 0), 0);
            const grossProfit = sales - totalCost; 

            const income = filteredPettyCash.filter(p => p.type === 'income').reduce((sum, p) => sum + p.amount, 0);
            const expense = filteredPettyCash.filter(p => p.type === 'expense').reduce((sum, p) => sum + p.amount, 0);
            
            const netProfit = grossProfit + income - expense;
            
            return { sales, grossProfit, totalCost, income, expense, netProfit, transactionsCount: filteredTransactions.length, filteredTransactions };
        };

        window.analyzeWeeklySales = (transactions) => {
            const weekStart = window.getWeekStartTimestamp();
            const filteredTransactions = transactions.filter(t => t.timestamp >= weekStart);
            
            const salesMap = {};
            
            filteredTransactions.forEach(t => {
                t.items.forEach(item => {
                    if (!salesMap[item.name]) {
                        salesMap[item.name] = { quantity: 0, profit: 0 };
                    }
                    salesMap[item.name].quantity += item.quantity;
                    salesMap[item.name].profit += item.grossProfit || ((item.price - (item.cost || 0)) * item.quantity);
                });
            });

            const topSelling = Object.entries(salesMap)
                .map(([name, data]) => ({ name, ...data }))
                .sort((a, b) => b.quantity - a.quantity)
                .slice(0, 5);
                
            return {
                topSelling,
                totalProfit: filteredTransactions.reduce((sum, t) => sum + t.grossProfit, 0)
            };
        };


        window.renderReports = () => {
            const { transactions, pettyCash } = window.appState;
            const dailyReport = window.generateReport(transactions, pettyCash, 'daily');
            const monthlyReport = window.generateReport(transactions, pettyCash, 'monthly');
            const weeklyAnalysis = window.analyzeWeeklySales(transactions);
            
            const todayDate = new Date().toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            
            const dailyReportContent = window.generateDailyReportHtml(dailyReport, todayDate);

            const reportCards = (title, report) => `
                <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 mb-4">
                    <h3 class="text-xl font-bold text-gray-800 mb-3">${title}</h3>
                    
                    <div class="bg-blue-50 p-3 rounded-lg mb-3">
                        <p class="text-sm font-semibold text-blue-700">LABA BERSIH</p>
                        <p class="text-3xl font-extrabold ${report.netProfit >= 0 ? 'text-blue-600' : 'text-red-600'}">${window.formatRupiah(report.netProfit)}</p>
                    </div>

                    <div class="space-y-2 text-sm">
                        <p class="flex justify-between font-semibold"><span>Penjualan Kotor</span><span class="text-cyan-600">${window.formatRupiah(report.sales)}</span></p>
                        <p class="flex justify-between font-semibold"><span>Laba Kotor Penjualan</span><span class="text-green-500">${window.formatRupiah(report.grossProfit)}</span></p>
                        <p class="flex justify-between font-semibold"><span>Pemasukan Lain</span><span class="text-green-500">${window.formatRupiah(report.income)}</span></p>
                        <p class="flex justify-between font-semibold"><span>Pengeluaran Op.</span><span class="text-red-600">(${window.formatRupiah(report.expense)})</span></p>
                    </div>
                </div>
            `;
            
            const topSellingHtml = weeklyAnalysis.topSelling.map((item, index) => `
                <div class="flex justify-between items-center py-1 border-b border-dotted last:border-b-0">
                    <span class="font-semibold text-gray-700">${index + 1}. ${item.name}</span>
                    <span class="text-sm text-cyan-600 font-bold">${item.quantity} Unit (Laba: ${window.formatRupiah(item.profit)})</span>
                </div>
            `).join('') || '<p class="text-center text-gray-500 text-sm py-2">Belum ada data penjualan minggu ini.</p>';

            return `
                <div class="pb-6">
                    <h2 class="text-2xl font-extrabold text-gray-800 mb-4">Laporan Penjualan & Keuangan</h2>
                    
                    <div class="bg-purple-100 p-5 rounded-xl shadow-lg border border-purple-300 mb-6">
                        <h3 class="text-xl font-bold text-purple-700 mb-3">‚≠ê Analisis Produk Terlaris Minggu Ini</h3>
                        <p class="text-3xl font-extrabold text-purple-600 mb-3">${window.formatRupiah(weeklyAnalysis.totalProfit)} <span class="text-base font-semibold text-gray-600">Laba Kotor</span></p>
                        <div class="space-y-1 bg-white p-3 rounded-lg border border-purple-200">
                            ${topSellingHtml}
                        </div>
                    </div>
                    
                    ${reportCards('Laporan Harian ('+todayDate+')', dailyReport)}
                    <button onclick="window.downloadFullDailyReportPng('${todayDate}')" class="mb-4 w-full py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition duration-150 flex items-center justify-center space-x-2">
                        <span>üíæ Download Laporan Harian Lengkap (PNG)</span> <span class="text-lg">üñºÔ∏è</span>
                    </button>
                    
                    ${reportCards('Laporan Bulanan', monthlyReport)}

                    <div class="mt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center space-x-2">
                            <span>üßæ</span> <span>Detail Transaksi Harian (${dailyReport.transactionsCount} TRX)</span>
                        </h3>
                        <div class="space-y-2 max-h-96 overflow-y-scroll p-2 bg-gray-50 rounded-lg border border-gray-200">
                             ${dailyReport.filteredTransactions.map(t => `
                                <div class="bg-white p-3 rounded-lg shadow-sm flex flex-col border border-gray-200">
                                    <div class="flex justify-between items-center pb-1 border-b border-dashed">
                                        <div>
                                            <p class="font-semibold text-gray-800">#${t.id}</p>
                                            <p class="text-xs text-gray-500">${new Date(t.timestamp).toLocaleTimeString('id-ID')} | Kasir: ${t.cashierName}</p>
                                        </div>
                                        <span class="font-extrabold text-cyan-600">${window.formatRupiah(t.total)}</span>
                                    </div>
                                    <div class="flex justify-between space-x-2 mt-2">
                                        <button onclick="window.showReceiptModal('${t.id}')" class="flex-1 text-xs text-purple-500 hover:text-purple-700 font-semibold border border-purple-200 py-1 rounded">
                                            Struk Ulang (PNG/Share)
                                        </button>
                                        <button onclick="window.confirmDeleteTransaction('${t.id}')" class="flex-1 text-xs text-red-500 hover:text-red-700 font-semibold border border-red-200 py-1 rounded">
                                            Hapus Transaksi üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            `).join('') || '<p class="text-center text-gray-500 p-4">Tidak ada transaksi hari ini.</p>'}
                        </div>
                    </div>
                </div>
                <div id="hidden_daily_report_container" style="position: absolute; left: -9999px; top: -9999px;">
                    ${dailyReportContent}
                </div>
            `;
        };
        
        window.generateDailyReportHtml = (report, dateString) => {
            const { settings } = window.appState;
            const reportItemsHtml = report.filteredTransactions.map(t => `
                <div style="display: flex; justify-content: space-between; font-size: 10px; line-height: 1.2;">
                    <span style="width: 30%;">${new Date(t.timestamp).toLocaleTimeString('id-ID')}</span>
                    <span style="width: 40%;">#${t.id}</span>
                    <span style="width: 30%; text-align: right;">${window.formatRupiah(t.total)}</span>
                </div>
            `).join('');

            return `
                <div class="report-print-area mx-auto" id="daily-report-area">
                    <div style="text-align: center; margin-bottom: 10px;">
                        <p style="font-size: 14px; font-weight: bold;">LAPORAN HARIAN ${settings.storeName}</p>
                        <p style="font-size: 11px;">Tgl: ${dateString}</p>
                        <p style="font-size: 11px;">Dicetak: ${window.formatDate(Date.now())}</p>
                    </div>
                    
                    <div style="border-top: 1px dashed #4b5563; border-bottom: 1px dashed #4b5563; padding: 5px 0; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 12px;">
                            <span>PENJUALAN KOTOR (${report.transactionsCount} TRX)</span>
                            <span>${window.formatRupiah(report.sales)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px;">
                            <span>Laba Kotor Penjualan</span>
                            <span>${window.formatRupiah(report.grossProfit)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #ef4444;">
                            <span>Harga Beli/Modal</span>
                            <span>(${window.formatRupiah(report.totalCost)})</span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <p style="font-weight: bold; font-size: 12px; margin-bottom: 5px;">Detail Transaksi:</p>
                        ${reportItemsHtml}
                    </div>

                    <div style="border-top: 1px dashed #4b5563; padding-top: 5px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 12px; color: #10b981;">
                            <span>PEMASUKAN LAIN</span>
                            <span>${window.formatRupiah(report.income)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 12px; color: #ef4444;">
                            <span>PENGELUARAN OPERASIONAL</span>
                            <span>(${window.formatRupiah(report.expense)})</span>
                        </div>
                    </div>
                    
                    <div style="border-top: 2px solid #06b6d4; padding-top: 5px;">
                        <div style="display: flex; justify-content: space-between; font-weight: 900; font-size: 14px; color: ${report.netProfit >= 0 ? '#06b6d4' : '#ef4444'};">
                            <span>LABA BERSIH HARI INI</span>
                            <span>${window.formatRupiah(report.netProfit)}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        window.downloadFullDailyReportPng = (dateString) => {
            window.closeModal(); 
            const reportArea = document.getElementById('daily-report-area');
            if (!reportArea) return window.showModal('Error', 'Laporan tidak ditemukan.');

            html2canvas(reportArea, { scale: 3, useCORS: true }).then(canvas => {
                const dataUrl = canvas.toDataURL('image/png');
                window.downloadFile(dataUrl, `laporan_harian_${dateString.replace(/[^a-zA-Z0-9]/g, '_')}.png`, 'image/png');
                window.showModal('Sukses', 'Laporan Harian berhasil diunduh (PNG).');
            });
        };
        
        window.confirmDeleteTransaction = (transactionId) => {
            const transaction = window.appState.transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
             window.showModal('Konfirmasi Hapus Transaksi', `
                 <p class="text-red-700 font-bold mb-4">Yakin ingin menghapus Transaksi #${transaction.id} (${window.formatRupiah(transaction.total)})?</p>
                 <p class="text-sm text-gray-700 mb-4">Tindakan ini akan **mengembalikan stok barang** yang terjual pada transaksi ini. Ini tidak dapat dibatalkan.</p>
                 <div class="flex justify-end space-x-3">
                     <button onclick="window.closeModal()" class="py-2 px-4 bg-gray-200 rounded-lg">Batal</button>
                     <button onclick="window.deleteTransaction('${transactionId}')" class="py-2 px-4 bg-red-600 text-white font-bold rounded-lg">YA, HAPUS & KEMBALIKAN STOK</button>
                 </div>
             `, false);
        }
        
        window.deleteTransaction = (transactionId) => {
            const transactionIndex = window.appState.transactions.findIndex(t => t.id === transactionId);
            if (transactionIndex === -1) return window.closeModal();
            
            const transaction = window.appState.transactions[transactionIndex];

            // 1. Kembalikan Stok Barang
            transaction.items.forEach(item => {
                const product = window.appState.products.find(p => p.id === item.id);
                if (product) {
                    product.stock += item.quantity;
                }
            });
            
            // 2. Hapus Transaksi
            window.appState.transactions.splice(transactionIndex, 1);

            // 3. Simpan & Render
            saveToLocalStorage();
            window.showModal('Sukses', `Transaksi #${transactionId} berhasil dihapus dan stok dikembalikan.`);
            renderApp();
        };

        // --- Logic Halaman Settings (Impor/Ekspor All & Logo) ---

        window.renderSettings = () => {
            const { settings } = window.appState;
            
            return `
                <div class="pb-6">
                    <h2 class="text-2xl font-extrabold text-gray-800 mb-4">Pengaturan Aplikasi</h2>

                    <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 mb-6">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">Informasi Toko</h3>
                        <form onsubmit="window.saveSettings(event)">
                            <div class="mb-4">
                                <label for="store-name" class="block text-sm font-medium text-gray-700">Nama Toko</label>
                                <input type="text" id="store-name" value="${settings.storeName}" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                            <div class="mb-4">
                                <label for="cashier-name" class="block text-sm font-medium text-gray-700">Nama Kasir</label>
                                <input type="text" id="cashier-name" value="${settings.cashierName}" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                            <div class="mb-4">
                                <label for="address" class="block text-sm font-medium text-gray-700">Alamat (Struk)</label>
                                <input type="text" id="address" value="${settings.address}" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                            <div class="mb-4">
                                <label for="logo-upload" class="block text-sm font-medium text-gray-700">Logo Toko (untuk Struk)</label>
                                <div class="flex items-center space-x-3">
                                    <input type="file" id="logo-upload" accept="image/*" onchange="window.handleLogoUpload(event)" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-50 file:text-cyan-700 hover:file:bg-cyan-100">
                                    ${settings.logoUrl ? `<button type="button" onclick="window.removeLogo()" class="text-red-500 text-2xl" title="Hapus Logo">üóëÔ∏è</button>` : ''}
                                </div>
                                ${settings.logoUrl ? `<img src="${settings.logoUrl}" class="mt-3 h-10 w-10 object-contain mx-auto border p-1 rounded-full" alt="Logo Toko">` : ''}
                            </div>
                            <button type="submit" class="w-full py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150">
                                Simpan Pengaturan
                            </button>
                        </form>
                    </div>

                    <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 mb-6">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">Backup & Restore Data</h3>
                        <button onclick="window.exportAllDataJson()" class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 mb-3">
                            üíæ Ekspor Semua Data (JSON)
                        </button>
                        <label for="import-json-file" class="w-full block py-3 text-center bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 cursor-pointer mb-3">
                            ‚¨ÜÔ∏è Impor Semua Data (JSON)
                        </label>
                        <input type="file" id="import-json-file" accept=".json" onchange="window.importAllDataJson(event)" class="hidden">
                        <button onclick="window.confirmDeleteAllData()" class="w-full py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700">
                            üî• Hapus Semua Data Lokal
                        </button>
                    </div>
                </div>
            `;
        };
        
        window.saveSettings = (event) => {
            event.preventDefault();
            window.appState.settings.storeName = document.getElementById('store-name').value;
            window.appState.settings.cashierName = document.getElementById('cashier-name').value;
            window.appState.settings.address = document.getElementById('address').value;
            saveToLocalStorage();
            window.showModal('Sukses', 'Pengaturan berhasil disimpan!');
            renderApp();
        };

        window.handleLogoUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                window.appState.settings.logoUrl = e.target.result;
                saveToLocalStorage();
                renderApp();
            };
            reader.readAsDataURL(file);
        };

        window.removeLogo = () => {
            if (!confirm('Yakin ingin menghapus logo?')) return;
            window.appState.settings.logoUrl = '';
            saveToLocalStorage();
            renderApp();
        };

        window.exportAllDataJson = () => {
            const allData = {
                settings: window.appState.settings,
                products: window.appState.products,
                transactions: window.appState.transactions,
                pettyCash: window.appState.pettyCash
            };
            const jsonString = JSON.stringify(allData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            window.downloadFile(url, `arkasir_backup_${new Date().toISOString().slice(0, 10)}.json`, 'application/json');
            window.showModal('Ekspor Sukses', 'Semua data berhasil diunduh sebagai file JSON.');
        };
        
        window.importAllDataJson = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            if (!confirm('Yakin ingin menimpa semua data lokal dengan file ini?')) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.settings && importedData.products && importedData.transactions) {
                        window.appState.settings = importedData.settings;
                        window.appState.products = importedData.products;
                        window.appState.transactions = importedData.transactions;
                        window.appState.pettyCash = importedData.pettyCash || []; 
                        
                        saveToLocalStorage();
                        window.showModal('Sukses Impor', 'Semua data berhasil diimpor dan ditimpa.');
                        renderApp();
                    } else {
                        throw new Error('Struktur file JSON tidak valid.');
                    }
                } catch (error) {
                    window.showModal('Error Impor', 'Gagal mengimpor file JSON. Pastikan file valid.');
                }
            };
            reader.readAsText(file);
        };
        
        window.confirmDeleteAllData = () => {
             window.showModal('Konfirmasi Hapus Data', `
                 <p class="text-red-700 font-bold mb-4">PERINGATAN! Yakin ingin menghapus SEMUA DATA?</p>
                 <p class="text-sm text-gray-700 mb-4">Ini akan menghapus semua Produk, Transaksi, Kas Kecil, dan Pengaturan yang tersimpan di browser ini. **Pastikan Anda sudah melakukan Ekspor/Backup Data.**</p>
                 <div class="flex justify-end space-x-3">
                     <button onclick="window.closeModal()" class="py-2 px-4 bg-gray-200 rounded-lg">Batal</button>
                     <button onclick="window.deleteAllData()" class="py-2 px-4 bg-red-600 text-white font-bold rounded-lg">YA, HAPUS SEMUA DATA</button>
                 </div>
             `, false);
        };

        window.deleteAllData = () => {
            localStorage.removeItem('arkasir_settings');
            localStorage.removeItem('arkasir_products');
            localStorage.removeItem('arkasir_transactions');
            localStorage.removeItem('arkasir_pettyCash');
            
            // Reset appState
            window.appState.settings = DEFAULT_SETTINGS;
            window.appState.products = DEFAULT_PRODUCTS;
            window.appState.cart = [];
            window.appState.transactions = [];
            window.appState.pettyCash = [];
            
            window.showModal('Sukses', 'Semua data aplikasi berhasil dihapus. Aplikasi di-reset.');
            navigate('POS');
        };

        // --- Render Utama Aplikasi ---
        window.renderApp = () => {
            const contentArea = document.getElementById('content-area');
            let contentHtml = '';

            switch (window.appState.currentPage) {
                case 'POS': contentHtml = window.renderPOS(); break;
                case 'Reports': contentHtml = window.renderReports(); break;
                case 'Settings': contentHtml = window.renderSettings(); break;
                case 'PettyCash': contentHtml = window.renderPettyCash(); break;
                case 'Products': contentHtml = window.renderProducts(); break;
                default: contentHtml = `<div class="p-4 text-center text-red-500">Halaman tidak ditemukan.</div>`;
            }

            contentArea.innerHTML = contentHtml;

            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('text-cyan-600', 'font-bold'));
            const activeIndex = ['POS', 'PettyCash', 'Reports', 'Products'].indexOf(window.appState.currentPage);
            if (activeIndex !== -1) {
                document.querySelector(`.nav-btn:nth-child(${activeIndex + 1})`).classList.add('text-cyan-600', 'font-bold');
            }

            if (window.appState.currentPage === 'POS') {
                setTimeout(() => document.getElementById('barcode-input')?.focus(), 100);
            }
        };
        
        window.onload = () => {
            window.renderApp();
        };
    </script>
</body>
</html>
