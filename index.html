<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARKASIR PRO V7 - FINAL EDITION</title>
    
    <meta name="theme-color" content="#3b82f6"> <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="ARKASIR V7">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/192/3b82f6/ffffff?text=A7"> 

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@800;900&family=Inter:wght@300;400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }

        .arkasir-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            letter-spacing: 2px;
        }
        
        .compact-list-item {
            padding: 0.6rem 0.75rem;
            font-size: 0.875rem; /* text-sm */
        }
        
        /* Gaya Latar Belakang POS */
        #pos-content {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #f8fafc;
            /* Filter gelap untuk menjaga teks tetap terlihat */
            position: relative;
        }
        #pos-content::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.75); /* Lapisan putih semi-transparan */
            z-index: 0; 
        }
        .pos-z-1 > * { z-index: 1; position: relative; }

        /* Gaya Struk Print/PNG */
        .receipt-preview {
            width: 300px;
            padding: 8px; 
            font-size: 9px; 
            line-height: 1.2;
        }
        
        /* HACK: Aturan Cetak (Print CSS) */
        @media print {
            body > *:not(.print-area) { display: none !important; }
            .print-area {
                display: block;
                position: absolute;
                top: 0;
                left: 0;
                width: 300px;
                margin: 0;
                padding: 0;
                box-shadow: none;
            }
            .receipt-preview { width: 100%; }
            .report-print-area { width: 400px; }
            @page { margin: 0; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

    <div id="app" class="flex flex-col flex-grow max-w-md mx-auto w-full shadow-2xl bg-white rounded-t-xl overflow-hidden">

        <header class="p-4 bg-blue-600 text-white shadow-xl flex justify-between items-center sticky top-0 z-20">
            <h1 class="text-xl arkasir-title">ARKASIR PRO V7</h1>
            <button onclick="navigate('Settings')" class="text-white hover:text-blue-200 p-1 rounded-full transition duration-150">
                <span class="text-2xl">‚öôÔ∏è</span>
            </button>
        </header>

        <main id="content-area" class="flex-grow p-3 overflow-y-auto pb-20"></main>

        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] border-t border-gray-100 z-50">
            <div class="flex justify-around items-center h-16">
                <button onclick="navigate('POS')" class="nav-btn flex flex-col items-center justify-center p-2 text-sm text-gray-500 hover:text-blue-600 transition duration-150">
                    <span class="text-2xl">üõí</span>
                    <span class="mt-0.5 font-medium">KASIR</span>
                </button>
                <button onclick="navigate('PettyCash')" class="nav-btn flex flex-col items-center justify-center p-2 text-sm text-gray-500 hover:text-blue-600 transition duration-150">
                    <span class="text-2xl">üí∞</span>
                    <span class="mt-0.5 font-medium">KAS KECIL</span>
                </button>
                <button onclick="navigate('Reports')" class="nav-btn flex flex-col items-center justify-center p-2 text-sm text-gray-500 hover:text-blue-600 transition duration-150">
                    <span class="text-2xl">üìà</span>
                    <span class="mt-0.5 font-medium">LAPORAN</span>
                </button>
                <button onclick="navigate('Products')" class="nav-btn flex flex-col items-center justify-center p-2 text-sm text-gray-500 hover:text-blue-600 transition duration-150">
                    <span class="text-2xl">üì¶</span>
                    <span class="mt-0.5 font-medium">PRODUK</span>
                </button>
            </div>
        </nav>

    </div>

    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-[100]">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl m-4 max-w-sm w-full p-5">
            </div>
    </div>

    <div id="print-export-area" class="fixed top-0 left-0 opacity-0 -z-50 print-area"></div>
    
    <script>
        // --- üü¢ PWA / Service Worker Setup ---
        const PWA_VERSION = 'v7_0_final';
        
        // ... (Manifest dan Service Worker tetap sama seperti V6, hanya ganti PWA_VERSION) ...
        const manifestData = {
          "name": "ARKASIR PRO V7 FINAL",
          "short_name": "ARKASIR V7",
          "description": "Aplikasi Kasir Mobile Lengkap (PWA) - V7 Final",
          "start_url": "./ARKASIR_V7_FINAL.html",
          "display": "standalone",
          "background_color": "#ffffff",
          "theme_color": "#3b82f6",
          "icons": [
            {"src": "https://via.placeholder.com/192/3b82f6/ffffff?text=A7", "sizes": "192x192", "type": "image/png", "purpose": "any maskable"},
            {"src": "https://via.placeholder.com/512/3b82f6/ffffff?text=A7", "sizes": "512x512", "type": "image/png"}
          ]
        };
        const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
        const manifestUrl = URL.createObjectURL(manifestBlob);
        
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestUrl;
        document.head.appendChild(link);

        const serviceWorkerScript = `
            const CACHE_NAME = 'arkasir-v7-cache-${PWA_VERSION}';
            const urlsToCache = [
              './ARKASIR_V7_FINAL.html', 
            ];
            
            self.addEventListener('install', event => {
              event.waitUntil(
                caches.open(CACHE_NAME).then(cache => {
                    return cache.addAll(urlsToCache);
                })
              );
              self.skipWaiting();
            });

            self.addEventListener('fetch', event => {
              event.respondWith(
                caches.match(event.request).then(response => {
                    if (response) return response;
                    return fetch(event.request);
                })
              );
            });

            self.addEventListener('activate', event => {
              const cacheWhitelist = [CACHE_NAME];
              event.waitUntil(
                caches.keys().then(cacheNames => {
                  return Promise.all(
                    cacheNames.map(cacheName => {
                      if (cacheWhitelist.indexOf(cacheName) === -1) {
                        return caches.delete(cacheName);
                      }
                    })
                  );
                })
              );
            });
        `;
        const swBlob = new Blob([serviceWorkerScript], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(swBlob);
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register(swUrl)
                    .then(reg => console.log('Service Worker registered.'))
                    .catch(err => console.log('Service Worker failed: ', err));
            });
        }
        
        // --- üìö Data & State Management ---
        const DEFAULT_SETTINGS = { storeName: 'TOKO ANDA PRO V7', cashierName: 'Kasir Utama', address: 'Alamat Toko Anda di Kota', logoUrl: '', posBackground: '' }; // Tambah posBackground
        const DEFAULT_PRODUCTS = [
            { id: 'prod1', name: 'Kopi Susu', price: 18000, stock: 50, barcode: '12345' }, // Hapus 'cost'
            { id: 'prod2', name: 'Roti Panggang', price: 15000, stock: 30, barcode: '67890' }, // Hapus 'cost'
        ];
        
        window.appState = {
            settings: DEFAULT_SETTINGS,
            products: DEFAULT_PRODUCTS,
            cart: [],
            transactions: [],
            pettyCash: [],
            currentPage: 'POS',
            scanTarget: null, 
            codeReader: null, 
        };

        function loadFromLocalStorage() {
            const storedSettings = localStorage.getItem('arkasir_settings_v7');
            const storedProducts = localStorage.getItem('arkasir_products_v7');
            const storedTransactions = localStorage.getItem('arkasir_transactions_v7');
            const storedPettyCash = localStorage.getItem('arkasir_pettyCash_v7');
            
            if (storedSettings) window.appState.settings = { ...window.appState.settings, ...JSON.parse(storedSettings) };
            if (storedProducts) window.appState.products = JSON.parse(storedProducts).map(p => ({
                ...p,
                // Hilangkan 'cost' pada saat load jika masih ada dari V6
                cost: undefined, 
                stock: p.stock !== undefined ? p.stock : 0 
            }));
            if (storedTransactions) window.appState.transactions = JSON.parse(storedTransactions);
            if (storedPettyCash) window.appState.pettyCash = JSON.parse(storedPettyCash);
            
            // Atur background POS saat load
            if (window.appState.settings.posBackground) {
                document.documentElement.style.setProperty('--pos-bg-image', `url(${window.appState.settings.posBackground})`);
            }
        }

        function saveToLocalStorage() {
            localStorage.setItem('arkasir_settings_v7', JSON.stringify(window.appState.settings));
            localStorage.setItem('arkasir_products_v7', JSON.stringify(window.appState.products.map(p => {
                // Pastikan 'cost' tidak disimpan
                const { cost, ...rest } = p;
                return rest;
            })));
            localStorage.setItem('arkasir_transactions_v7', JSON.stringify(window.appState.transactions));
            localStorage.setItem('arkasir_pettyCash_v7', JSON.stringify(window.appState.pettyCash));
        }

        loadFromLocalStorage();

        // --- üõ†Ô∏è Global Helper Functions ---

        window.navigate = (page) => {
            window.appState.currentPage = page;
            if (window.appState.codeReader) {
                window.appState.codeReader.reset();
                window.appState.codeReader = null;
            }
            renderApp();
        };

        window.formatRupiah = (number) => {
            if (isNaN(number) || number === null) return 'Rp 0';
            const value = Math.round(number); 
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(value);
        };
        
        window.formatDate = (timestamp) => {
            const date = new Date(timestamp);
            const datePart = date.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const timePart = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            return `${datePart} ${timePart}`;
        }

        window.showModal = (title, contentHtml, showClose = true) => {
            const modalBackdrop = document.getElementById('modal-backdrop');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-blue-600">${title}</h3>
                    ${showClose ? `<button onclick="window.closeModal()" class="text-gray-400 hover:text-gray-600">
                        <span class="text-xl">‚úï</span>
                    </button>` : ''}
                </div>
                ${contentHtml}
            `;
            modalBackdrop.classList.remove('hidden');
            modalBackdrop.classList.add('flex');
        };

        window.closeModal = () => {
            const modalBackdrop = document.getElementById('modal-backdrop');
            modalBackdrop.classList.add('hidden');
            modalBackdrop.classList.remove('flex');
            
            if (window.appState.codeReader) {
                window.appState.codeReader.reset();
                window.appState.codeReader = null;
            }
        };
        
        window.downloadFile = (dataUrl, filename, mimeType) => {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        
        // --- üì∑ Barcode Scanning (Dipertahankan) ---
        // ... (Fungsi scanner tetap sama) ...
        window.openBarcodeScanner = (targetPage) => {
            window.showModal('SCAN BARCODE CEPAT', `
                <div id="scanner-container" class="w-full h-48 relative overflow-hidden rounded-lg mb-3 bg-black">
                    <video id="scanner-video-element" class="w-full h-full"></video>
                </div>
                <p id="scanner-status" class="text-center text-sm text-gray-500 mt-2">Memuat kamera...</p>
                <div class="flex justify-end mt-3">
                    <button onclick="window.closeModal()" class="py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm">
                        STOP SCAN
                    </button>
                </div>
            `, false);
            
            window.appState.scanTarget = targetPage;
            setTimeout(window.startZxingScanner, 500);
        };

        window.startZxingScanner = () => {
            const statusElement = document.getElementById('scanner-status');
            const videoElement = document.getElementById('scanner-video-element');
            
            try {
                window.appState.codeReader = new ZXing.BrowserMultiFormatReader();

                window.appState.codeReader.getVideoInputDevices().then((videoInputDevices) => {
                    if (videoInputDevices.length === 0) {
                        statusElement.textContent = 'Tidak ada perangkat kamera ditemukan.';
                        return;
                    }

                    const selectedDeviceId = videoInputDevices.find(
                        device => device.label.toLowerCase().includes('back') || device.label.toLowerCase().includes('environment')
                    )?.deviceId || videoInputDevices[0].deviceId;

                    statusElement.textContent = 'Mencari barcode...';

                    window.appState.codeReader.decodeFromVideoDevice(selectedDeviceId, videoElement, (result, err) => {
                        if (result) {
                            const barcode = result.getText();
                            
                            window.appState.codeReader.reset();
                            window.appState.codeReader = null;
                            window.closeModal();

                            if (window.appState.scanTarget === 'POS') {
                                window.handleScannedBarcodePOS(barcode);
                            } else if (window.appState.scanTarget === 'Products') {
                                window.handleScannedBarcodeProducts(barcode);
                            }
                        }
                    });

                }).catch(err => {
                    statusElement.textContent = 'Gagal memuat kamera. Cek izin browser/perangkat.';
                });

            } catch (error) {
                statusElement.textContent = 'Gagal menginisialisasi scanner (ZXing).';
            }
        };

        window.handleScannedBarcodePOS = (barcode) => {
            const product = window.appState.products.find(p => p.barcode === barcode);
            
            if (product) {
                window.addToCart(product.id);
            } else {
                window.showModal('PRODUK TIDAK DITEMUKAN', `Barcode <b>${barcode}</b> tidak cocok.`);
            }
        };

        window.handleScannedBarcodeProducts = (barcode) => {
            const barcodeInput = document.getElementById('product-barcode');
            if (barcodeInput) {
                barcodeInput.value = barcode;
                window.showModal('BARCODE TERISI', `Barcode <b>${barcode}</b> berhasil diisi ke form Produk.`);
                setTimeout(() => { window.closeModal(); }, 1500);
            }
        };
        
        window.handleBarcodeScan = (event) => {
            const input = event.target;
            const value = input.value.trim();
            
            if ((event.key === 'Enter' || event.type === 'change') && value.length > 0) {
                const product = window.appState.products.find(p => p.barcode === value || p.name.toLowerCase().includes(value.toLowerCase()));
                if (product) {
                    window.addToCart(product.id);
                    input.value = ''; 
                } else {
                    if(event.key === 'Enter') {
                        window.showModal('PRODUK TIDAK DITEMUKAN', `Kode/Nama <b>${value}</b> tidak cocok.`);
                    }
                }
            }
        }

        // --- üõí Logic Halaman POS ---
        window.renderPOS = () => {
            const { products, cart, settings } = window.appState;
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            const backgroundStyle = settings.posBackground 
                ? `background-image: url('${settings.posBackground}');` 
                : '';
                
            // Tampilan cart
            const cartHtml = cart.length === 0
                ? '<p class="text-center text-gray-600 pt-8 text-sm pos-z-1">Keranjang kosong. Tambahkan produk!</p>'
                : cart.map((item) => {
                    const productData = products.find(p => p.id === item.id) || {};
                    const isOutOfStock = productData.stock !== undefined && item.quantity > productData.stock;
                    return `
                        <div class="flex justify-between items-center compact-list-item border-b last:border-b-0 ${isOutOfStock ? 'bg-red-200' : 'bg-white hover:bg-gray-100'} pos-z-1">
                            <div class="flex-grow">
                                <p class="font-semibold text-gray-800 text-sm">${item.name}</p>
                                <p class="text-xs text-gray-600">${window.formatRupiah(item.price)} x ${item.quantity} ${isOutOfStock ? `<span class="text-red-700 font-bold">‚ö†Ô∏è Stok Kurang (${productData.stock || 0} sisa)</span>` : ''}</p>
                            </div>
                            <div class="flex items-center space-x-1">
                                <span class="font-bold text-blue-600 text-sm w-20 text-right">${window.formatRupiah(item.price * item.quantity)}</span>
                                <button onclick="window.updateCartQuantity('${item.id}', -1)" class="text-red-500 p-1 rounded-full text-lg leading-none">‚ûñ</button>
                                <button onclick="window.updateCartQuantity('${item.id}', 1)" class="text-blue-500 p-1 rounded-full text-lg leading-none">‚ûï</button>
                                <button onclick="window.removeFromCart('${item.id}')" class="text-gray-500 hover:text-red-700 p-1 rounded-full text-lg leading-none">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                }).join('');

            // Tampilan produk
            const productListHtml = products.filter(p => p.stock > 0).map(product => `
                <button onclick="window.addToCart('${product.id}')" class="bg-white p-3 rounded-lg shadow-sm border border-gray-200 text-left hover:bg-blue-50 transition duration-100 pos-z-1">
                    <p class="font-semibold text-gray-800 text-sm truncate">${product.name}</p>
                    <p class="text-xs text-blue-600 font-bold">${window.formatRupiah(product.price)}</p>
                </button>
            `).join('');

            const isStockWarning = cart.some(item => {
                const productData = products.find(p => p.id === item.id);
                return productData.stock !== undefined && item.quantity > productData.stock;
            });
            
            const paymentDisabled = cart.length === 0 || isStockWarning;


            return `
                <div id="pos-content" class="flex flex-col h-full space-y-3 p-3 -m-3 flex-grow" style="${backgroundStyle}">
                    <h2 class="text-xl font-extrabold text-gray-800 mb-1 pos-z-1">KASIR TRANSAKSI</h2>

                    <div class="sticky top-0 bg-white pt-1 pb-2 z-10 border-b border-gray-100 -mx-3 px-3 pos-z-1">
                        <div class="flex items-center space-x-2">
                            <input type="text" id="barcode-input" onkeyup="window.handleBarcodeScan(event)" placeholder="Kode/Nama Produk (Enter)" class="flex-grow p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                            <button onclick="window.openBarcodeScanner('POS')" class="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-150 flex items-center text-sm">
                                üì∑ SCAN
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-2 mb-3 max-h-24 overflow-y-scroll p-2 bg-white/70 rounded-lg border border-gray-200 pos-z-1">
                        ${productListHtml.length > 0 ? productListHtml : '<p class="col-span-3 text-center text-gray-600 text-xs p-1 pos-z-1">Tidak ada produk tersedia/stok habis.</p>'}
                    </div>

                    <div class="flex-grow bg-white/90 border border-gray-200 rounded-lg shadow-inner overflow-y-scroll max-h-80 pos-z-1">
                        ${cartHtml}
                    </div>
                    
                    ${isStockWarning ? '<p class="text-red-700 font-bold text-center mt-2 p-2 bg-red-200 rounded-lg text-sm pos-z-1">‚ö† Stok barang tidak mencukupi!</p>' : ''}

                    <div class="sticky bottom-0 bg-white p-3 -mx-3 border-t border-gray-200 shadow-xl pos-z-1">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-xl font-semibold text-gray-700">TOTAL</span>
                            <span class="text-3xl font-extrabold text-blue-700">${window.formatRupiah(total)}</span>
                        </div>
                        <button onclick="window.processPayment()" ${paymentDisabled ? 'disabled' : ''} class="w-full py-3 bg-blue-600 text-white font-bold text-lg rounded-lg shadow-lg hover:bg-blue-700 transition duration-150 disabled:bg-gray-400">
                            BAYAR SEKARANG
                        </button>
                    </div>
                </div>
            `;
            
            // Perlu update DOM agar background image terpasang
            setTimeout(() => {
                const posContent = document.getElementById('pos-content');
                if (posContent && settings.posBackground) {
                    posContent.style.backgroundImage = `url('${settings.posBackground}')`;
                }
            }, 50);
        };
        
        window.addToCart = (productId) => {
            const product = window.appState.products.find(p => p.id === productId);
            if (!product) return;
            
            const existingItem = window.appState.cart.find(item => item.id === productId);
            const currentQuantity = existingItem ? existingItem.quantity : 0;
            
            if (currentQuantity + 1 > (product.stock || Infinity)) {
                 window.showModal('STOK HABIS/KURANG', `Stok produk <b>${product.name}</b> hanya tersisa ${product.stock || 0}.`);
                 return;
            }

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                window.appState.cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    // Hapus cost
                    quantity: 1,
                });
            }
            window.navigate('POS');
        };

        window.updateCartQuantity = (productId, change) => {
            const item = window.appState.cart.find(item => item.id === productId);
            if (!item) return;

            const product = window.appState.products.find(p => p.id === productId);
            const newQuantity = item.quantity + change;
            
            if (change > 0 && newQuantity > (product.stock || Infinity)) {
                 window.showModal('STOK HABIS/KURANG', `Stok produk <b>${product.name}</b> hanya tersisa ${product.stock || 0}. Tidak bisa menambah lagi.`);
                 return;
            }

            item.quantity = newQuantity;

            if (item.quantity <= 0) {
                window.removeFromCart(productId);
            } else {
                window.navigate('POS');
            }
        };
        
        window.removeFromCart = (productId) => {
            window.appState.cart = window.appState.cart.filter(item => item.id !== productId);
            window.navigate('POS');
        };
        
        window.processPayment = () => {
            const total = window.appState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            window.showModal('PEMBAYARAN', `
                <p class="text-xl font-bold mb-4">Total: <span class="text-blue-600">${window.formatRupiah(total)}</span></p>
                <div class="mb-4">
                    <label for="paid-amount" class="block text-sm font-medium text-gray-700">Jumlah Bayar (Rp)</label>
                    <input type="number" id="paid-amount" value="${total}" min="${total}" required oninput="window.calculateChange(${total})" class="mt-1 block w-full p-3 text-lg border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <p class="text-lg font-bold mb-4">Kembalian: <span id="change-display" class="text-green-600">${window.formatRupiah(0)}</span></p>
                <button onclick="window.finalizeTransaction(${total})" class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">
                    SELESAIKAN TRANSAKSI
                </button>
            `);
            setTimeout(() => document.getElementById('paid-amount')?.focus(), 100);
            window.calculateChange(total); 
        };
        
        window.calculateChange = (total) => {
            const paid = parseFloat(document.getElementById('paid-amount').value) || 0;
            const change = paid - total;
            document.getElementById('change-display').textContent = window.formatRupiah(change > 0 ? change : 0);
            document.querySelector('#modal-content button').disabled = paid < total;
        };
        
        window.finalizeTransaction = (total) => {
            const paid = parseFloat(document.getElementById('paid-amount').value) || 0;
            const change = paid - total;

            if (paid < total) {
                return window.showModal('PEMBAYARAN KURANG', 'Jumlah pembayaran harus mencukupi total belanja.');
            }
            
            // 1. Update Stok & Hitung Laba Kotor (Laba Kotor = Penjualan karena tidak ada harga beli)
            let grossProfit = total; // Laba Kotor = Penjualan Total
            const itemsForTransaction = window.appState.cart.map(item => {
                const productInStock = window.appState.products.find(p => p.id === item.id);
                
                if (productInStock) {
                    productInStock.stock -= item.quantity;
                }
                
                // cost dan grossProfit dihitung berdasarkan harga jual
                const itemGrossProfit = (item.price || 0) * (item.quantity || 0); 

                return { 
                    id: item.id, 
                    name: item.name, 
                    price: item.price,
                    quantity: item.quantity,
                    cost: 0, // Ditetapkan 0 karena dihilangkan
                    grossProfit: itemGrossProfit 
                };
            });

            // 2. Simpan Transaksi
            const transactionId = 'TRX-' + Date.now().toString().slice(-8);
            const transactionData = {
                items: itemsForTransaction, 
                total: total,
                paid: paid,
                change: change,
                grossProfit: grossProfit, 
                timestamp: Date.now(),
                cashierName: window.appState.settings.cashierName || 'Kasir',
            };
            
            window.appState.transactions.unshift({ id: transactionId, ...transactionData });
            
            // 3. Simpan & Reset
            saveToLocalStorage();
            window.appState.cart = [];
            window.closeModal();
            window.navigate('POS');
            window.showReceiptModal({ id: transactionId, ...transactionData });
        };
        
        // --- üñ®Ô∏è Struk & Share Logic (Tidak berubah) ---
        window.generateReceiptHtml = (transaction) => {
            if (!transaction || !transaction.items || transaction.items.length === 0) return '<p class="text-center">Struk kosong atau tidak valid.</p>';
            
            const { settings } = window.appState;
            const datetime = window.formatDate(transaction.timestamp); 

            const itemsHtml = (transaction.items || []).map(item => {
                const itemTotal = (item.price || 0) * (item.quantity || 0);
                return `
                    <div style="display: flex; font-size: 9px; line-height: 1.1;">
                        <span style="width: 50%;">${item.name}</span>
                        <span style="width: 25%; text-align: right;">${item.quantity} x</span>
                        <span style="width: 25%; text-align: right;">${window.formatRupiah(itemTotal)}</span>
                    </div>
                `;
            }).join('');
            
            if (itemsHtml.trim() === '') return '<p class="text-center">Struk kosong atau tidak valid.</p>';


            return `
                <div class="receipt-preview text-center mx-auto" id="receipt-area-${transaction.id}">
                    ${settings.logoUrl ? `<img src="${settings.logoUrl}" alt="Logo" style="margin: 0 auto; width: 30px; height: 30px; object-fit: contain; margin-bottom: 4px;">` : ''}
                    <p style="font-size: 10px; font-weight: bold;">${settings.storeName}</p>
                    <p style="font-size: 9px;">${settings.address}</p>
                    <p style="font-size: 9px; margin-bottom: 8px;">Kasir: ${transaction.cashierName || 'Kasir'}</p>
                    <div style="border-top: 1px dashed #6b7280; border-bottom: 1px dashed #6b7280; padding: 4px 0; margin-bottom: 8px;">
                        <p style="font-size: 9px; display: flex; justify-content: space-between;">
                            <span>Tgl/Waktu: ${datetime}</span>
                            <span>ID: ${transaction.id}</span>
                        </p>
                    </div>

                    <div style="text-align: left; font-size: 9px; margin-bottom: 8px; line-height: 1.2;">
                        ${itemsHtml}
                    </div>

                    <div style="border-top: 1px dashed #6b7280; padding-top: 4px; margin-bottom: 8px; text-align: right; font-size: 9px;">
                        <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 10px;">
                            <span>TOTAL</span>
                            <span>${window.formatRupiah(transaction.total || 0)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>BAYAR</span>
                            <span>${window.formatRupiah(transaction.paid || 0)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 10px; color: #3b82f6;">
                            <span>KEMBALIAN</span>
                            <span>${window.formatRupiah(transaction.change || 0)}</span>
                        </div>
                    </div>

                    <p style="font-size: 9px; margin-top: 12px;">*** TERIMA KASIH ***</p>
                </div>
            `;
        };
        
        window.showReceiptModal = (transaction) => {
            // ... (Fungsi showReceiptModal tetap sama, hanya ganti warna) ...
            const receiptHtml = window.generateReceiptHtml(transaction);
            
            if (receiptHtml.includes('Struk kosong atau tidak valid')) {
                return window.showModal('ERROR', 'Data transaksi tidak lengkap atau tidak valid untuk ditampilkan.');
            }

            const contentHtml = `
                <div class="flex flex-col items-center">
                    <p class="text-blue-600 font-bold mb-3 text-sm">TRANSAKSI SELESAI!</p>
                    ${receiptHtml}
                    <div class="mt-4 w-full space-y-2">
                        <button onclick="window.printReceiptById('${transaction.id}')" class="w-full py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 flex items-center justify-center space-x-2 text-sm">
                            <span>üñ®Ô∏è CETAK STRUK</span>
                        </button>
                        <button onclick="window.shareReceipt('${transaction.id}')" class="w-full py-2 bg-purple-500 text-white font-semibold rounded-lg hover:bg-purple-600 flex items-center justify-center space-x-2 text-sm">
                            <span>üì≤ SHARE (PNG)</span>
                        </button>
                        <button onclick="window.downloadReceiptPng('${transaction.id}')" class="w-full py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 flex items-center justify-center space-x-2 text-sm">
                            <span>üñºÔ∏è SIMPAN PNG</span>
                        </button>
                    </div>
                </div>
            `;
            window.showModal('PREVIEW STRUK', contentHtml, true);
        };
        
        // ... (Fungsi Print, Download, Share Struk tetap sama) ...
        window.printReceiptById = (transactionId) => {
            const transaction = window.appState.transactions.find(t => t.id === transactionId);
            if (!transaction) return window.showModal('ERROR', 'Transaksi tidak ditemukan.');
            
            const receiptHtml = window.generateReceiptHtml(transaction);
            if (receiptHtml.includes('Struk kosong')) return window.showModal('GAGAL CETAK', 'Struk kosong atau tidak valid.');
            
            const printExportArea = document.getElementById('print-export-area');
            printExportArea.innerHTML = receiptHtml.replace(`id="receipt-area-${transactionId}"`, `id="temp-print-receipt"`);

            window.print();

            setTimeout(() => {
                printExportArea.innerHTML = ''; 
            }, 500);
            
            window.closeModal(); 
        };
        
        window.downloadReceiptPng = (transactionId) => {
            const transaction = window.appState.transactions.find(t => t.id === transactionId);
            if (!transaction) return window.showModal('ERROR', 'Transaksi tidak ditemukan.');
            
            window.closeModal(); 

            const receiptHtml = window.generateReceiptHtml(transaction);
            if (receiptHtml.includes('Struk kosong')) return window.showModal('GAGAL EXPORT', 'Struk kosong atau tidak valid.');
            
            const printExportArea = document.getElementById('print-export-area');
            
            printExportArea.innerHTML = receiptHtml.replace(`id="receipt-area-${transactionId}"`, `id="temp-export-receipt"`);
            const receiptArea = document.getElementById('temp-export-receipt');


            html2canvas(receiptArea, { scale: 3, useCORS: true }).then(canvas => {
                printExportArea.innerHTML = ''; 
                const dataUrl = canvas.toDataURL('image/png');
                window.downloadFile(dataUrl, `struk_kasir_${transactionId}.png`, 'image/png');
                window.showModal('SUKSES', `Struk #${transactionId} berhasil diunduh (PNG).`);
            }).catch(err => {
                window.showModal('ERROR', `Gagal membuat gambar struk: ${err.message}`);
            });
        };
        
        window.shareReceipt = (transactionId) => {
            const transaction = window.appState.transactions.find(t => t.id === transactionId);
            if (!transaction) return window.showModal('ERROR', 'Transaksi tidak ditemukan.');
            
            window.closeModal(); 

            const receiptHtml = window.generateReceiptHtml(transaction);
            if (receiptHtml.includes('Struk kosong')) return window.showModal('GAGAL SHARE', 'Struk kosong atau tidak valid.');
            
            const printExportArea = document.getElementById('print-export-area');
            printExportArea.innerHTML = receiptHtml.replace(`id="receipt-area-${transactionId}"`, `id="temp-share-receipt"`);
            const receiptArea = document.getElementById('temp-share-receipt');

            html2canvas(receiptArea, { scale: 3, useCORS: true }).then(canvas => {
                printExportArea.innerHTML = ''; 
                
                if (navigator.share && canvas.toBlob) {
                    canvas.toBlob((blob) => {
                        const file = new File([blob], `struk_kasir_${transactionId}.png`, { type: 'image/png' });
                        navigator.share({
                            title: `Struk ARKASIR - ${transaction.id}`,
                            text: `Berikut struk transaksi dari ${window.appState.settings.storeName} (${window.formatRupiah(transaction.total)})`,
                            files: [file],
                        })
                        .then(() => console.log('Share successful'))
                        .catch((error) => window.showModal('ERROR SHARE', `Gagal share: ${error.message}`));
                    }, 'image/png');
                    
                } else {
                    window.showModal('SHARE', 'Browser Anda tidak mendukung Web Share API. File akan diunduh sebagai ganti share.');
                    const dataUrl = canvas.toDataURL('image/png');
                    window.downloadFile(dataUrl, `struk_kasir_${transactionId}.png`, 'image/png');
                }
            }).catch(err => {
                window.showModal('ERROR', `Gagal membuat gambar struk untuk share: ${err.message}`);
            });
        }
        
        // --- üì¶ Logic Halaman Produk ---

        window.renderProducts = () => {
            const { products } = window.appState;

            const listHtml = products.map(product => `
                <div class="flex justify-between items-center compact-list-item bg-white rounded-lg shadow-sm border border-gray-200 hover:bg-gray-50">
                    <div class="flex-grow pr-2">
                        <p class="font-bold text-gray-800 text-sm truncate">${product.name}</p>
                        <p class="text-xs text-blue-600">Jual: ${window.formatRupiah(product.price)}</p>
                        <p class="text-xs ${product.stock <= 5 ? 'text-red-500 font-bold' : 'text-gray-500'}">Stok: ${product.stock} ${product.stock <= 5 ? ' (RENDAH)' : ''}</p>
                    </div>
                    <div class="flex space-x-1">
                        <button onclick="window.editProduct('${product.id}')" class="text-blue-500 hover:text-blue-700 p-1 text-lg">
                            ‚úèÔ∏è
                        </button>
                        <button onclick="window.deleteProduct('${product.id}')" class="text-red-500 hover:text-red-700 p-1 text-lg">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('');

            return `
                <div class="pb-6">
                    <h2 class="text-xl font-extrabold text-gray-800 mb-3">MANAJEMEN PRODUK</h2>
                    <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-200 mb-4">
                        <h3 id="product-form-title" class="text-lg font-bold text-purple-600 mb-3 flex items-center space-x-2">
                            <span>‚ûï</span> <span class="flex-grow">TAMBAH PRODUK BARU</span>
                        </h3>
                        <form id="product-form" onsubmit="window.saveProduct(event)">
                            <input type="hidden" id="product-id" value="">
                            <div class="mb-3">
                                <label for="product-name" class="block text-xs font-medium text-gray-700">Nama Produk</label>
                                <input type="text" id="product-name" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label for="product-price" class="block text-xs font-medium text-gray-700">Harga Jual (Rp)</label>
                                    <input type="number" id="product-price" required min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg text-sm">
                                </div>
                                <div>
                                    <label for="product-stock" class="block text-xs font-medium text-gray-700">Stok Saat Ini</label>
                                    <input type="number" id="product-stock" required min="0" value="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg text-sm">
                                </div>
                                <input type="hidden" id="product-cost" value="0"> 
                            </div>
                           
                            <div class="mb-4">
                                <label for="product-barcode" class="block text-xs font-medium text-gray-700">Barcode/Kode Angka</label>
                                <div class="flex">
                                    <input type="text" id="product-barcode" placeholder="Opsional: Kode angka unik" class="flex-grow p-2 border border-gray-300 rounded-l-lg text-sm">
                                    <button type="button" onclick="window.openBarcodeScanner('Products')" class="p-2 bg-purple-600 text-white rounded-r-lg hover:bg-purple-700 transition duration-150 flex items-center text-sm">
                                        üì∑ SCAN
                                    </button>
                                </div>
                            </div>
                            <button type="submit" id="product-submit-btn" class="w-full py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-150 text-sm">
                                SIMPAN PRODUK
                            </button>
                            <button type="button" onclick="window.resetProductForm()" class="w-full py-2 mt-2 text-purple-600 font-semibold rounded-lg border border-purple-600 hover:bg-purple-50 transition duration-150 hidden text-sm" id="product-cancel-btn">
                                BATAL EDIT
                            </button>
                        </form>
                    </div>
                    
                    <div class="flex space-x-2 mb-4">
                        <button onclick="window.exportToCsv('products')" class="flex-1 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 text-sm">
                            üíæ EKSPOR CSV
                        </button>
                        <label for="import-products-file" class="flex-1 block py-2 text-center bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 cursor-pointer text-sm">
                            ‚¨ÜÔ∏è IMPOR CSV
                        </label>
                        <input type="file" id="import-products-file" accept=".csv" onchange="window.importProductsCsv(event)" class="hidden">
                    </div>

                    <div class="mt-2">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">DAFTAR PRODUK (${products.length} Item)</h3>
                        <div class="space-y-2 max-h-96 overflow-y-scroll p-2 bg-gray-50 rounded-lg border border-gray-200">
                            ${listHtml.length > 0 ? listHtml : '<p class="text-center text-gray-500 p-3 text-sm">Tidak ada produk.</p>'}
                        </div>
                    </div>
                </div>
            `;
        };
        
        window.saveProduct = (event) => {
            event.preventDefault();
            const id = document.getElementById('product-id').value;
            const name = document.getElementById('product-name').value;
            const price = parseFloat(document.getElementById('product-price').value);
            const stock = parseInt(document.getElementById('product-stock').value);
            const barcode = document.getElementById('product-barcode').value.trim();

            if (!name || isNaN(price) || price <= 0 || isNaN(stock) || stock < 0) return window.showModal('GAGAL', 'Semua input wajib diisi dan harus valid.');

            // Cost diset 0, dihilangkan dari form
            const cost = 0; 
            const productData = { name, price, cost, stock, barcode };
            
            if (id) {
                const index = window.appState.products.findIndex(p => p.id === id);
                if (index !== -1) window.appState.products[index] = { id, ...productData };
                window.showModal('SUKSES', `Produk <b>${name}</b> berhasil diupdate.`);
            } else {
                const newId = 'PROD-' + Date.now().toString().slice(-8);
                window.appState.products.push({ id: newId, ...productData });
                window.showModal('SUKSES', `Produk <b>${name}</b> berhasil ditambahkan.`);
            }
            
            saveToLocalStorage();
            document.getElementById('product-form').reset();
            window.resetProductForm();
            renderApp();
        };
        
        window.editProduct = (id) => {
            const product = window.appState.products.find(p => p.id === id);
            if (!product) return;

            document.getElementById('product-form-title').innerHTML = `<span>‚úèÔ∏è</span> <span class="flex-grow">EDIT PRODUK: ${product.name}</span>`;
            document.getElementById('product-id').value = product.id;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-stock').value = product.stock;
            document.getElementById('product-barcode').value = product.barcode;
            document.getElementById('product-submit-btn').textContent = 'UPDATE PRODUK';
            document.getElementById('product-cancel-btn').classList.remove('hidden');
            
            document.getElementById('content-area').scrollTo(0, 0); 
        };
        
        window.resetProductForm = () => {
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            document.getElementById('product-form-title').innerHTML = `<span>‚ûï</span> <span class="flex-grow">TAMBAH PRODUK BARU</span>`;
            document.getElementById('product-submit-btn').textContent = 'SIMPAN PRODUK';
            document.getElementById('product-cancel-btn').classList.add('hidden');
        };
        
        window.deleteProduct = (id) => {
            const product = window.appState.products.find(p => p.id === id);
             if (!confirm(`Yakin ingin menghapus produk ${product.name}?`)) return;
             
             window.appState.products = window.appState.products.filter(p => p.id !== id);
             saveToLocalStorage();
             window.showModal('SUKSES', `Produk <b>${product.name}</b> berhasil dihapus.`);
             renderApp();
        };
        
        window.convertToCsv = (data, type) => {
            if (type === 'products') {
                // Hapus 'cost' dari header export
                const headers = ['id', 'name', 'price', 'stock', 'barcode'];
                const rows = data.map(p => headers.map(h => `"${p[h] !== undefined ? p[h] : ''}"`).join(','));
                return [headers.join(','), ...rows].join('\n');
            }
            return '';
        };

        window.exportToCsv = (type) => {
            let data;
            let filename;

            if (type === 'products') {
                data = window.appState.products;
                filename = `ARKASIR_PRODUK_${new Date().toISOString().slice(0, 10)}.csv`;
            } else {
                return;
            }

            const csvContent = window.convertToCsv(data, type);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            window.downloadFile(url, filename, 'text/csv');
            window.showModal('EKSPOR SUKSES', `Data ${type} berhasil diunduh sebagai file CSV.`);
        };
        
        // ... (Fungsi importProductsCsv tetap sama, namun Cost diabaikan) ...

        // --- üí∞ Logic Halaman PettyCash ---
        // ... (Fungsi PettyCash tetap sama, hanya ganti warna) ...
        window.renderPettyCash = () => {
            const { pettyCash } = window.appState;
            
            const totalIncome = (pettyCash || []).filter(p => p.type === 'income').reduce((sum, p) => sum + (p.amount || 0), 0);
            const totalExpense = (pettyCash || []).filter(p => p.type === 'expense').reduce((sum, p) => sum + (p.amount || 0), 0);
            const currentBalance = totalIncome - totalExpense;

            const listHtml = (pettyCash || []).map(p => `
                <div class="flex justify-between items-center compact-list-item bg-white rounded-lg shadow-sm border border-gray-200 hover:bg-gray-50">
                    <div class="flex-grow pr-2">
                        <p class="font-bold text-gray-800 text-sm truncate">${p.description}</p>
                        <p class="text-xs text-gray-500">${window.formatDate(p.timestamp)} | <span class="font-semibold ${p.type === 'income' ? 'text-green-600' : 'text-red-600'}">${p.type === 'income' ? 'Pemasukan' : 'Pengeluaran'}</span></p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="font-bold text-sm ${p.type === 'income' ? 'text-green-600' : 'text-red-600'} w-24 text-right">${p.type === 'expense' ? '-' : ''}${window.formatRupiah(p.amount || 0)}</span>
                        <button onclick="window.editPettyCash('${p.id}')" class="text-blue-500 hover:text-blue-700 p-1 text-lg">‚úèÔ∏è</button>
                        <button onclick="window.deletePettyCash('${p.id}')" class="text-red-500 hover:text-red-700 p-1 text-lg">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');

            return `
                <div class="pb-6">
                    <h2 class="text-xl font-extrabold text-gray-800 mb-3">KAS KECIL (PETTY CASH)</h2>

                    <div class="bg-blue-50 p-4 rounded-xl shadow-lg border border-blue-300 mb-4">
                        <p class="text-xs font-semibold text-gray-600">Saldo Kas Saat Ini</p>
                        <p class="text-3xl font-extrabold text-blue-700">${window.formatRupiah(currentBalance)}</p>
                    </div>
                    
                    <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-200 mb-4">
                        <h3 class="text-lg font-bold text-blue-600 mb-3">CATAT TRANSAKSI KAS</h3>
                        <form id="pc-form" onsubmit="window.addPettyCash(event)">
                            <input type="hidden" id="pc-id" value="">
                            <div class="mb-3">
                                <label for="pc-type" class="block text-xs font-medium text-gray-700">Jenis Transaksi</label>
                                <select id="pc-type" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="expense">Pengeluaran</option>
                                    <option value="income">Pemasukan</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="pc-amount" class="block text-xs font-medium text-gray-700">Jumlah (Rp)</label>
                                <input type="number" id="pc-amount" required min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                            <div class="mb-4">
                                <label for="pc-description" class="block text-xs font-medium text-gray-700">Deskripsi</label>
                                <input type="text" id="pc-description" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                            <button type="submit" id="pc-submit-btn" class="w-full py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150 text-sm">
                                CATAT TRANSAKSI
                            </button>
                            <button type="button" onclick="window.resetPettyCashForm()" class="w-full py-2 mt-2 text-blue-600 font-semibold rounded-lg border border-blue-600 hover:bg-blue-50 transition duration-150 hidden text-sm" id="pc-cancel-btn">
                                BATAL
                            </button>
                        </form>
                    </div>

                    <div class="mt-4">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">RIWAYAT TRANSAKSI KAS</h3>
                        <div class="space-y-2 max-h-96 overflow-y-scroll p-2 bg-gray-50 rounded-lg border border-gray-200">
                            ${listHtml.length > 0 ? listHtml : '<p class="text-center text-gray-500 p-3 text-sm">Tidak ada riwayat kas kecil.</p>'}
                        </div>
                    </div>
                </div>
            `;
        };
        
        window.addPettyCash = (event) => {
            event.preventDefault();
            const id = document.getElementById('pc-id').value;
            const type = document.getElementById('pc-type').value;
            const amount = parseFloat(document.getElementById('pc-amount').value);
            const description = document.getElementById('pc-description').value;

            if (isNaN(amount) || amount <= 0) return window.showModal('GAGAL', 'Jumlah harus valid.');

            const newPC = {
                id: id || ('PC-' + Date.now().toString().slice(-8)),
                type,
                amount,
                description,
                timestamp: id ? (window.appState.pettyCash.find(p => p.id === id)?.timestamp || Date.now()) : Date.now(),
            };
            
            if (id) {
                const index = window.appState.pettyCash.findIndex(p => p.id === id);
                if (index !== -1) window.appState.pettyCash[index] = newPC;
                window.showModal('SUKSES', `Transaksi Kas berhasil diupdate.`);
            } else {
                 window.appState.pettyCash.unshift(newPC);
                 window.showModal('SUKSES', `Transaksi Kas (${type === 'income' ? 'Pemasukan' : 'Pengeluaran'}) berhasil dicatat.`);
            }

            saveToLocalStorage();
            window.resetPettyCashForm();
            renderApp();
        };

        window.editPettyCash = (id) => {
             const pc = window.appState.pettyCash.find(p => p.id === id);
             if (!pc) return;

             document.getElementById('pc-id').value = pc.id;
             document.getElementById('pc-type').value = pc.type;
             document.getElementById('pc-amount').value = pc.amount;
             document.getElementById('pc-description').value = pc.description;
             document.getElementById('pc-submit-btn').textContent = 'UPDATE TRANSAKSI';
             document.getElementById('pc-cancel-btn').classList.remove('hidden');
             
             document.getElementById('content-area').scrollTo(0, 0); 
        };
        
        window.resetPettyCashForm = () => {
             document.getElementById('pc-form')?.reset();
             document.getElementById('pc-id').value = '';
             document.getElementById('pc-submit-btn').textContent = 'CATAT TRANSAKSI';
             document.getElementById('pc-cancel-btn').classList.add('hidden');
        };

        window.deletePettyCash = (id) => {
            if (!confirm('Yakin ingin menghapus transaksi kas ini?')) return;
            window.appState.pettyCash = window.appState.pettyCash.filter(p => p.id !== id);
            saveToLocalStorage();
            renderApp();
        };

        // --- üìä Logic Halaman Laporan (FIXED & COMPACT) ---
        
        window.getTodayStartTimestamp = () => {
             const d = new Date();
             d.setHours(0, 0, 0, 0);
             return d.getTime();
        }

        window.getMonthStartTimestamp = () => {
             const d = new Date();
             d.setDate(1);
             d.setHours(0, 0, 0, 0);
             return d.getTime();
        }
        
        window.getWeekStartTimestamp = (date = new Date()) => {
            const d = new Date(date);
            const day = d.getDay() || 7; 
            d.setDate(d.getDate() - (day - 1)); 
            d.setHours(0, 0, 0, 0);
            return d.getTime();
        }
        
        // FUNGSI LAPORAN - Laba Kotor = Penjualan (karena tidak ada harga beli)
        window.generateReport = (transactions, pettyCash, period) => {
            let startTime = 0;
            if (period === 'daily') startTime = window.getTodayStartTimestamp();
            if (period === 'monthly') startTime = window.getMonthStartTimestamp();
            
            const filteredTransactions = (transactions || []).filter(t => t.timestamp >= startTime);
            const filteredPettyCash = (pettyCash || []).filter(p => p.timestamp >= startTime);
            
            // Perhitungan Penjualan dan Laba Kotor (Laba Kotor = Penjualan Total)
            const sales = filteredTransactions.reduce((sum, t) => sum + (t.total || 0), 0);
            const grossProfit = sales; 
            const totalCost = 0; // Cost dihilangkan

            // Perhitungan Kas Kecil (ROBUST)
            const income = filteredPettyCash.filter(p => p.type === 'income').reduce((sum, p) => sum + (p.amount || 0), 0);
            const expense = filteredPettyCash.filter(p => p.type === 'expense').reduce((sum, p) => sum + (p.amount || 0), 0);
            
            // Laba Bersih = Laba Kotor + Pemasukan Lain - Pengeluaran Operasional
            const netProfit = grossProfit + income - expense;
            
            return { sales, grossProfit, totalCost, income, expense, netProfit, transactionsCount: filteredTransactions.length, filteredTransactions, filteredPettyCash };
        };

        window.analyzeWeeklySales = (transactions) => {
            const weekStart = window.getWeekStartTimestamp();
            const filteredTransactions = (transactions || []).filter(t => t.timestamp >= weekStart);
            
            const salesMap = {};
            
            filteredTransactions.forEach(t => {
                (t.items || []).forEach(item => { 
                    const name = item.name || 'Produk Tidak Diketahui';
                    const quantity = item.quantity || 0;
                    // Profit = Penjualan Harga Jual
                    const profit = (item.price || 0) * quantity; 

                    if (!salesMap[name]) {
                        salesMap[name] = { quantity: 0, profit: 0 };
                    }
                    salesMap[name].quantity += quantity;
                    salesMap[name].profit += profit;
                });
            });

            const topSelling = Object.entries(salesMap)
                .map(([name, data]) => ({ name, ...data }))
                .sort((a, b) => b.quantity - a.quantity)
                .slice(0, 5);
                
            const totalProfit = filteredTransactions.reduce((sum, t) => sum + (t.grossProfit || 0), 0);
                
            return {
                topSelling,
                totalProfit
            };
        };


        window.renderReports = () => {
            const { transactions, pettyCash } = window.appState;
            
            const dailyReport = window.generateReport(transactions, pettyCash, 'daily');
            const monthlyReport = window.generateReport(transactions, pettyCash, 'monthly');
            const weeklyAnalysis = window.analyzeWeeklySales(transactions);
            
            const todayDate = new Date().toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            
            const dailyReportContentForPng = window.generateDailyReportHtml(dailyReport, todayDate);

            const reportCards = (title, report) => `
                <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-200 mb-3">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">${title}</h3>
                    
                    <div class="bg-blue-50 p-2 rounded-lg mb-3 flex justify-between items-center">
                        <div>
                            <p class="text-xs font-semibold text-blue-700">LABA BERSIH</p>
                            <p class="text-3xl font-extrabold ${report.netProfit >= 0 ? 'text-blue-600' : 'text-red-600'}">${window.formatRupiah(report.netProfit)}</p>
                        </div>
                        <span class="text-sm text-gray-500 font-semibold">${report.transactionsCount} Transaksi</span>
                    </div>

                    <div class="space-y-1 text-xs">
                        <p class="flex justify-between font-semibold border-b border-dashed pb-1"><span>Penjualan Kotor</span><span class="text-blue-600">${window.formatRupiah(report.sales)}</span></p>
                        <p class="flex justify-between"><span>Laba Kotor Penjualan</span><span class="text-blue-500">${window.formatRupiah(report.grossProfit)}</span></p>
                        <p class="flex justify-between"><span>Pemasukan Lain</span><span class="text-green-500">${window.formatRupiah(report.income)}</span></p>
                        <p class="flex justify-between"><span>Pengeluaran Op.</span><span class="text-red-600">(${window.formatRupiah(report.expense)})</span></p>
                    </div>
                </div>
            `;
            
            const topSellingHtml = weeklyAnalysis.topSelling.map((item, index) => `
                <div class="flex justify-between items-center py-1 text-sm border-b border-dotted last:border-b-0">
                    <span class="font-semibold text-gray-700">${index + 1}. ${item.name}</span>
                    <span class="text-xs text-blue-600 font-bold">${item.quantity} Unit (Laba: ${window.formatRupiah(item.profit)})</span>
                </div>
            `).join('') || '<p class="text-center text-gray-500 text-xs py-1">Belum ada data penjualan minggu ini.</p>';
            
            const pettyCashDetailHtml = dailyReport.filteredPettyCash.map(pc => `
                 <div class="flex justify-between py-1 text-xs border-b border-dotted last:border-b-0">
                     <div class="flex-grow pr-2">
                         <span class="font-semibold ${pc.type === 'income' ? 'text-green-700' : 'text-red-700'}">${pc.type === 'income' ? 'Pemasukan' : 'Pengeluaran'}</span>
                         <span class="text-gray-500"> (${new Date(pc.timestamp).toLocaleTimeString('id-ID').slice(0, 5)})</span>
                         <p class="text-xs italic text-gray-600">${pc.description}</p>
                     </div>
                     <span class="font-bold w-20 text-right ${pc.type === 'income' ? 'text-green-600' : 'text-red-600'}">${pc.type === 'expense' ? '-' : ''}${window.formatRupiah(pc.amount || 0)}</span>
                     <button onclick="window.editPettyCash('${pc.id}')" class="text-xs text-blue-500 hover:text-blue-700 p-1 ml-1" title="Edit">‚úèÔ∏è</button>
                 </div>
            `).join('') || '<p class="text-center text-gray-500 p-2 text-sm">Tidak ada catatan kas kecil hari ini.</p>';


            return `
                <div class="pb-6">
                    <h2 class="text-xl font-extrabold text-gray-800 mb-3">LAPORAN & ANALISIS</h2>
                    
                    <div class="bg-purple-100 p-4 rounded-xl shadow-lg border border-purple-300 mb-4">
                        <h3 class="text-lg font-bold text-purple-700 mb-2">‚≠ê ANALISIS PRODUK TERLARIS MINGGU INI</h3>
                        <p class="text-2xl font-extrabold text-purple-600 mb-3">${window.formatRupiah(weeklyAnalysis.totalProfit)} <span class="text-sm font-semibold text-gray-600">Laba Kotor</span></p>
                        <div class="space-y-1 bg-white p-2 rounded-lg border border-purple-200">
                            ${topSellingHtml}
                        </div>
                    </div>
                    
                    ${reportCards('LAPORAN HARIAN ('+todayDate+')', dailyReport)}
                    <button onclick="window.downloadFullDailyReportPng('${todayDate}')" class="mb-4 w-full py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150 flex items-center justify-center space-x-2 text-sm">
                        <span>üíæ DOWNLOAD LAPORAN HARIAN LENGKAP (PNG)</span>
                    </button>
                    
                    <div class="mt-4 bg-white p-4 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">DETAIL KAS KECIL HARI INI</h3>
                        <div class="space-y-1 p-2 bg-gray-50 rounded-lg border border-gray-200">
                            ${pettyCashDetailHtml}
                        </div>
                    </div>


                    ${reportCards('LAPORAN BULANAN', monthlyReport)}

                    <div class="mt-4">
                        <h3 class="text-lg font-bold text-gray-800 mb-2 flex items-center space-x-2">
                            <span>üßæ</span> <span>DETAIL TRANSAKSI HARIAN (${dailyReport.transactionsCount} TRX)</span>
                        </h3>
                        <div class="space-y-2 max-h-96 overflow-y-scroll p-2 bg-gray-50 rounded-lg border border-gray-200">
                             ${dailyReport.filteredTransactions.map(t => `
                                <div class="bg-white p-3 rounded-lg shadow-sm flex flex-col border border-gray-200 hover:bg-gray-50">
                                    <div class="flex justify-between items-center pb-1 border-b border-dashed">
                                        <div>
                                            <p class="font-semibold text-gray-800 text-sm">#${t.id}</p>
                                            <p class="text-xs text-gray-500">${new Date(t.timestamp).toLocaleTimeString('id-ID').slice(0, 5)} | ${t.cashierName || 'Kasir'}</p>
                                        </div>
                                        <span class="font-extrabold text-blue-600 text-sm">${window.formatRupiah(t.total || 0)}</span>
                                    </div>
                                    <div class="flex justify-between space-x-2 mt-2">
                                        <button onclick="window.editTransactionModal('${t.id}')" class="flex-1 text-xs text-blue-500 hover:text-blue-700 font-semibold border border-blue-200 py-1 rounded">
                                            KOREKSI/EDIT ‚úèÔ∏è
                                        </button>
                                        <button onclick="window.showReceiptModal('${t.id}')" class="flex-1 text-xs text-purple-500 hover:text-purple-700 font-semibold border border-purple-200 py-1 rounded">
                                            STRUK ULANG
                                        </button>
                                        <button onclick="window.confirmDeleteTransaction('${t.id}')" class="flex-1 text-xs text-red-500 hover:text-red-700 font-semibold border border-red-200 py-1 rounded">
                                            HAPUS üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            `).join('') || '<p class="text-center text-gray-500 p-3 text-sm">Tidak ada transaksi hari ini.</p>'}
                        </div>
                    </div>
                </div>
                <div id="hidden_daily_report_container" class="fixed top-0 left-0 -z-50 opacity-0">
                    ${dailyReportContentForPng}
                </div>
            `;
        };
        
        window.generateDailyReportHtml = (report, dateString) => {
            const { settings } = window.appState;
            
            const reportItemsHtml = report.filteredTransactions.map(t => `
                <div style="display: flex; justify-content: space-between; font-size: 10px; line-height: 1.2;">
                    <span style="width: 30%;">${new Date(t.timestamp).toLocaleTimeString('id-ID').slice(0, 5)}</span>
                    <span style="width: 40%;">#${t.id}</span>
                    <span style="width: 30%; text-align: right;">${window.formatRupiah(t.total || 0)}</span>
                </div>
            `).join('');

            const pcDetailHtml = report.filteredPettyCash.map(pc => `
                <div style="display: flex; justify-content: space-between; font-size: 10px; line-height: 1.2;">
                    <span style="width: 70%; font-style: italic;">${pc.type === 'income' ? 'Msk:' : 'Klr:'} ${pc.description}</span>
                    <span style="width: 30%; text-align: right; color: ${pc.type === 'income' ? '#16a34a' : '#dc2626'}; font-weight: bold;">${pc.type === 'expense' ? '-' : ''}${window.formatRupiah(pc.amount || 0)}</span>
                </div>
            `).join('');


            return `
                <div class="report-print-area mx-auto bg-white p-4" id="daily-report-png-target">
                    <div style="text-align: center; margin-bottom: 10px;">
                        <p style="font-size: 14px; font-weight: bold;">LAPORAN HARIAN ${settings.storeName}</p>
                        <p style="font-size: 11px;">Tgl: ${dateString}</p>
                        <p style="font-size: 11px;">Dicetak: ${window.formatDate(Date.now())}</p>
                    </div>
                    
                    <div style="border-top: 1px dashed #4b5563; border-bottom: 1px dashed #4b5563; padding: 5px 0; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 12px; color: #3b82f6;">
                            <span>PENJUALAN KOTOR (${report.transactionsCount} TRX)</span>
                            <span>${window.formatRupiah(report.sales)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 11px;">
                            <span>Laba Kotor Penjualan</span>
                            <span>${window.formatRupiah(report.grossProfit)}</span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <p style="font-weight: bold; font-size: 12px; margin-bottom: 5px;">Detail Transaksi:</p>
                        ${reportItemsHtml}
                    </div>
                    
                    <div style="border-top: 1px dashed #4b5563; padding-top: 5px; margin-bottom: 10px;">
                        <p style="font-weight: bold; font-size: 12px; margin-bottom: 5px;">Detail Kas Kecil:</p>
                        ${pcDetailHtml}
                    </div>

                    <div style="border-top: 2px solid #3b82f6; padding-top: 5px;">
                        <div style="display: flex; justify-content: space-between; font-weight: 900; font-size: 14px; color: ${report.netProfit >= 0 ? '#3b82f6' : '#ef4444'};">
                            <span>LABA BERSIH HARI INI</span>
                            <span>${window.formatRupiah(report.netProfit)}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        window.downloadFullDailyReportPng = (dateString) => {
            window.closeModal(); 
            const reportArea = document.getElementById('daily-report-png-target');
            if (!reportArea) return window.showModal('ERROR', 'Laporan tidak ditemukan (pastikan halaman Laporan sudah dirender).');

            html2canvas(reportArea, { scale: 3, useCORS: true }).then(canvas => {
                const dataUrl = canvas.toDataURL('image/png');
                window.downloadFile(dataUrl, `LAPORAN_HARIAN_${dateString.replace(/[^a-zA-Z0-9]/g, '_')}.png`, 'image/png');
                window.showModal('SUKSES', 'Laporan Harian berhasil diunduh (PNG).');
            }).catch(err => {
                window.showModal('ERROR', `Gagal membuat gambar laporan: ${err.message}`);
            });
        };
        
        window.editTransactionModal = (transactionId) => {
            const transaction = window.appState.transactions.find(t => t.id === transactionId);
            if (!transaction) return window.showModal('ERROR', 'Transaksi tidak ditemukan.');
            
            const total = transaction.total;
            const itemsHtml = transaction.items.map((item, index) => `
                <div class="flex items-center space-x-2 mb-2 p-2 border rounded bg-gray-50">
                    <p class="flex-grow text-sm">${item.name}</p>
                    <input type="number" id="edit-qty-${index}" value="${item.quantity}" min="0" data-price="${item.price}" data-original-qty="${item.quantity}" class="w-16 p-1 border rounded text-center text-sm">
                    <span class="text-sm w-20 text-right">${window.formatRupiah(item.price)}</span>
                </div>
            `).join('');

            window.showModal(`KOREKSI TRANSAKSI #${transactionId}`, `
                <form id="edit-trx-form" onsubmit="window.finalizeEditTransaction(event, '${transactionId}')">
                    <p class="text-sm font-semibold mb-3">Tgl/Waktu: ${window.formatDate(transaction.timestamp)}</p>
                    <div class="mb-4 p-2 border rounded-lg max-h-48 overflow-y-scroll">
                        <p class="font-bold text-gray-700 mb-2">Item Transaksi (Koreksi Kuantitas):</p>
                        ${itemsHtml}
                    </div>
                    <div class="flex justify-between items-center mb-3">
                        <label for="edit-paid" class="block text-sm font-medium text-gray-700">Jumlah Bayar (Rp)</label>
                        <input type="number" id="edit-paid" value="${transaction.paid}" required class="w-32 p-1 border rounded text-right text-sm">
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-sm font-bold text-gray-700">Total Awal:</span>
                        <span class="text-lg font-extrabold text-blue-600">${window.formatRupiah(total)}</span>
                    </div>
                    <button type="submit" class="w-full py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 text-sm">
                        SIMPAN KOREKSI
                    </button>
                </form>
            `);
        };
        
        window.finalizeEditTransaction = (event, transactionId) => {
            event.preventDefault();
            const transactionIndex = window.appState.transactions.findIndex(t => t.id === transactionId);
            if (transactionIndex === -1) return window.showModal('ERROR', 'Transaksi tidak ditemukan.');
            
            const originalTransaction = JSON.parse(JSON.stringify(window.appState.transactions[transactionIndex])); // Deep copy
            let newTotal = 0;
            const newItems = [];
            const productUpdates = {}; // Untuk melacak perubahan stok

            // 1. Hitung ulang Total & Tentukan perubahan Stok
            originalTransaction.items.forEach((item, index) => {
                const input = document.getElementById(`edit-qty-${index}`);
                const newQuantity = parseInt(input.value) || 0;
                const originalQuantity = parseInt(input.getAttribute('data-original-qty')) || 0;
                
                if (newQuantity < 0) return window.showModal('Gagal Koreksi', 'Kuantitas tidak boleh negatif.');

                const price = parseFloat(input.getAttribute('data-price')) || 0;
                const itemTotal = price * newQuantity;
                newTotal += itemTotal;
                
                // Tambahkan item baru
                newItems.push({
                    ...item,
                    quantity: newQuantity,
                    grossProfit: price * newQuantity, 
                });
                
                // Hitung perubahan stok: Stok harus dikembalikan (originalQuantity) dan diambil lagi (newQuantity)
                const stockChange = originalQuantity - newQuantity;
                if (!productUpdates[item.id]) productUpdates[item.id] = 0;
                productUpdates[item.id] += stockChange; 
            });

            // 2. Update Stok di database produk
            for (const productId in productUpdates) {
                const product = window.appState.products.find(p => p.id === productId);
                if (product) {
                    product.stock += productUpdates[productId];
                }
            }

            // 3. Update Transaksi
            const paid = parseFloat(document.getElementById('edit-paid').value) || 0;
            if (paid < newTotal) return window.showModal('Gagal Koreksi', `Pembayaran (${window.formatRupiah(paid)}) kurang dari Total Baru (${window.formatRupiah(newTotal)}).`);

            window.appState.transactions[transactionIndex].items = newItems.filter(item => item.quantity > 0);
            window.appState.transactions[transactionIndex].total = newTotal;
            window.appState.transactions[transactionIndex].paid = paid;
            window.appState.transactions[transactionIndex].change = paid - newTotal;
            window.appState.transactions[transactionIndex].grossProfit = newTotal; 

            saveToLocalStorage();
            window.closeModal();
            window.showModal('SUKSES KOREKSI', `Transaksi #${transactionId} berhasil dikoreksi! Total Baru: ${window.formatRupiah(newTotal)}.`);
            renderApp();
        };

        
        window.confirmDeleteTransaction = (transactionId) => {
            const transaction = window.appState.transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
             window.showModal('KONFIRMASI HAPUS TRANSAKSI', `
                 <p class="text-red-700 font-bold mb-4 text-sm">Yakin ingin menghapus Transaksi #${transaction.id} (${window.formatRupiah(transaction.total || 0)})?</p>
                 <p class="text-xs text-gray-700 mb-4">Tindakan ini akan **mengembalikan stok barang** yang terjual pada transaksi ini.</p>
                 <div class="flex justify-end space-x-3">
                     <button onclick="window.closeModal()" class="py-2 px-3 bg-gray-200 rounded-lg text-sm">BATAL</button>
                     <button onclick="window.deleteTransaction('${transactionId}')" class="py-2 px-3 bg-red-600 text-white font-bold rounded-lg text-sm">YA, HAPUS & KEMBALIKAN STOK</button>
                 </div>
             `, false);
        }
        
        window.deleteTransaction = (transactionId) => {
            const transactionIndex = window.appState.transactions.findIndex(t => t.id === transactionId);
            if (transactionIndex === -1) return window.closeModal();
            
            const transaction = window.appState.transactions[transactionIndex];

            // 1. Kembalikan Stok Barang
            (transaction.items || []).forEach(item => { 
                const product = window.appState.products.find(p => p.id === item.id);
                if (product) {
                    product.stock += (item.quantity || 0);
                }
            });
            
            // 2. Hapus Transaksi
            window.appState.transactions.splice(transactionIndex, 1);

            // 3. Simpan & Render
            saveToLocalStorage();
            window.showModal('SUKSES', `Transaksi #${transactionId} berhasil dihapus dan stok dikembalikan.`);
            renderApp();
        };

        // --- ‚öôÔ∏è Logic Halaman Settings ---

        window.renderSettings = () => {
            const { settings } = window.appState;
            
            return `
                <div class="pb-6">
                    <h2 class="text-xl font-extrabold text-gray-800 mb-3">PENGATURAN APLIKASI</h2>
                    <p class="text-xs text-gray-500 mb-4">VERSI PWA: ${PWA_VERSION} - Data tersimpan di browser (Local Storage).</p>

                    <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-200 mb-4">
                        <h3 class="text-lg font-bold text-gray-700 mb-3">INFORMASI TOKO</h3>
                        <form onsubmit="window.saveSettings(event)">
                            <div class="mb-3">
                                <label for="store-name" class="block text-xs font-medium text-gray-700">Nama Toko</label>
                                <input type="text" id="store-name" value="${settings.storeName}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                            <div class="mb-3">
                                <label for="cashier-name" class="block text-xs font-medium text-gray-700">Nama Kasir</label>
                                <input type="text" id="cashier-name" value="${settings.cashierName}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                            <div class="mb-3">
                                <label for="address" class="block text-xs font-medium text-gray-700">Alamat (Struk)</label>
                                <input type="text" id="address" value="${settings.address}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                            <div class="mb-4">
                                <label for="logo-upload" class="block text-xs font-medium text-gray-700">Logo Toko (Struk)</label>
                                <div class="flex items-center space-x-3 mt-1">
                                    <input type="file" id="logo-upload" accept="image/*" onchange="window.handleLogoUpload(event)" class="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                    ${settings.logoUrl ? `<button type="button" onclick="window.removeLogo()" class="text-red-500 text-xl" title="Hapus Logo">üóëÔ∏è</button>` : ''}
                                </div>
                                ${settings.logoUrl ? `<img src="${settings.logoUrl}" class="mt-2 h-8 w-8 object-contain mx-auto border p-1 rounded-full" alt="Logo Toko">` : ''}
                            </div>
                            
                            <div class="mb-4 pt-4 border-t border-gray-100">
                                <label for="pos-bg-upload" class="block text-xs font-medium text-gray-700">Gambar Latar Belakang KASIR</label>
                                <div class="flex items-center space-x-3 mt-1">
                                    <input type="file" id="pos-bg-upload" accept="image/*" onchange="window.handlePosBackgroundUpload(event)" class="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                                    ${settings.posBackground ? `<button type="button" onclick="window.removePosBackground()" class="text-red-500 text-xl" title="Hapus Background">üóëÔ∏è</button>` : ''}
                                </div>
                                ${settings.posBackground ? `<p class="text-xs text-gray-500 mt-2">Latar Belakang aktif.</p>` : '<p class="text-xs text-gray-500 mt-2">Tidak ada latar belakang.</p>'}
                            </div>

                            <button type="submit" class="w-full py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150 text-sm">
                                SIMPAN PENGATURAN
                            </button>
                        </form>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-200 mb-4">
                        <h3 class="text-lg font-bold text-gray-700 mb-3">BACKUP & RESTORE DATA</h3>
                        <button onclick="window.exportAllDataJson()" class="w-full py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 mb-3 text-sm">
                            üíæ EKSPOR SEMUA DATA (JSON)
                        </button>
                        <label for="import-json-file" class="w-full block py-2 text-center bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 cursor-pointer mb-3 text-sm">
                            ‚¨ÜÔ∏è IMPOR SEMUA DATA (JSON)
                        </label>
                        <input type="file" id="import-json-file" accept=".json" onchange="window.importAllDataJson(event)" class="hidden">
                        <button onclick="window.confirmDeleteAllData()" class="w-full py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 text-sm">
                            üî• HAPUS SEMUA DATA LOKAL
                        </button>
                    </div>
                </div>
            `;
        };
        
        window.saveSettings = (event) => {
            event.preventDefault();
            window.appState.settings.storeName = document.getElementById('store-name').value;
            window.appState.settings.cashierName = document.getElementById('cashier-name').value;
            window.appState.settings.address = document.getElementById('address').value;
            saveToLocalStorage();
            window.showModal('SUKSES', 'Pengaturan berhasil disimpan!');
            renderApp();
        };
        
        window.handlePosBackgroundUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                window.appState.settings.posBackground = e.target.result;
                saveToLocalStorage();
                window.showModal('SUKSES', 'Gambar latar belakang kasir berhasil diunggah!');
                renderApp();
            };
            reader.readAsDataURL(file);
        };
        
        window.removePosBackground = () => {
            if (!confirm('Yakin ingin menghapus gambar latar belakang Kasir?')) return;
            window.appState.settings.posBackground = '';
            saveToLocalStorage();
            renderApp();
        };

        window.handleLogoUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                window.appState.settings.logoUrl = e.target.result;
                saveToLocalStorage();
                renderApp();
            };
            reader.readAsDataURL(file);
        };

        window.removeLogo = () => {
            if (!confirm('Yakin ingin menghapus logo?')) return;
            window.appState.settings.logoUrl = '';
            saveToLocalStorage();
            renderApp();
        };
        
        // ... (Fungsi Export/Import/Delete All Data tetap sama) ...
        window.exportAllDataJson = () => {
            const allData = {
                settings: window.appState.settings,
                products: window.appState.products,
                transactions: window.appState.transactions,
                pettyCash: window.appState.pettyCash,
                pwaVersion: PWA_VERSION 
            };
            const jsonString = JSON.stringify(allData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            window.downloadFile(url, `ARKASIR_BACKUP_V7_${new Date().toISOString().slice(0, 10)}.json`, 'application/json');
            window.showModal('EKSPOR SUKSES', 'Semua data berhasil diunduh sebagai file JSON.');
        };
        
        window.importAllDataJson = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            if (!confirm('Yakin ingin menimpa semua data lokal dengan file ini?')) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.settings && importedData.products && importedData.transactions) {
                        window.appState.settings = importedData.settings;
                        window.appState.products = importedData.products.map(p => {
                            // Hilangkan cost saat import agar sesuai V7
                            const { cost, ...rest } = p;
                            return rest;
                        });
                        window.appState.transactions = importedData.transactions;
                        window.appState.pettyCash = importedData.pettyCash || []; 
                        
                        saveToLocalStorage();
                        window.showModal('SUKSES IMPOR', 'Semua data berhasil diimpor dan ditimpa.');
                        renderApp();
                    } else {
                        throw new Error('Struktur file JSON tidak valid. Pastikan ini file backup ARKASIR.');
                    }
                } catch (error) {
                    window.showModal('ERROR IMPOR', 'Gagal mengimpor file JSON. Pastikan file valid.');
                }
            };
            reader.readAsText(file);
        };
        
        window.confirmDeleteAllData = () => {
             window.showModal('KONFIRMASI HAPUS DATA', `
                 <p class="text-red-700 font-bold mb-4 text-sm">PERINGATAN! Yakin ingin menghapus SEMUA DATA?</p>
                 <p class="text-xs text-gray-700 mb-4">Ini akan menghapus semua Produk, Transaksi, Kas Kecil, dan Pengaturan yang tersimpan di browser ini. **Wajib Backup data terlebih dahulu!**</p>
                 <div class="flex justify-end space-x-3">
                     <button onclick="window.closeModal()" class="py-2 px-3 bg-gray-200 rounded-lg text-sm">BATAL</button>
                     <button onclick="window.deleteAllData()" class="py-2 px-3 bg-red-600 text-white font-bold rounded-lg text-sm">YA, HAPUS SEMUA DATA</button>
                 </div>
             `, false);
        };

        window.deleteAllData = () => {
            localStorage.removeItem('arkasir_settings_v7');
            localStorage.removeItem('arkasir_products_v7');
            localStorage.removeItem('arkasir_transactions_v7');
            localStorage.removeItem('arkasir_pettyCash_v7');
            
            window.appState.settings = DEFAULT_SETTINGS;
            window.appState.products = DEFAULT_PRODUCTS;
            window.appState.cart = [];
            window.appState.transactions = [];
            window.appState.pettyCash = [];
            
            window.showModal('SUKSES', 'Semua data aplikasi berhasil dihapus. Aplikasi di-reset.');
            navigate('POS');
        };

        // --- üé® Render Utama Aplikasi ---
        window.renderApp = () => {
            const contentArea = document.getElementById('content-area');
            let contentHtml = '';

            try {
                switch (window.appState.currentPage) {
                    case 'POS': contentHtml = window.renderPOS(); break;
                    case 'Reports': contentHtml = window.renderReports(); break;
                    case 'Settings': contentHtml = window.renderSettings(); break;
                    case 'PettyCash': contentHtml = window.renderPettyCash(); break;
                    case 'Products': contentHtml = window.renderProducts(); break;
                    default: contentHtml = `<div class="p-4 text-center text-red-500">Halaman tidak ditemukan.</div>`;
                }
            } catch (error) {
                console.error("Render Error:", error);
                contentHtml = `
                    <div class="p-6 bg-red-100 border border-red-400 rounded-lg">
                        <h3 class="text-xl font-bold text-red-700 mb-2">‚ùå TERJADI KESALAHAN FATAL</h3>
                        <p class="text-sm text-red-600">Terjadi kesalahan saat memuat halaman <b>${window.appState.currentPage}</b>. Ini mungkin karena data yang tidak valid.</p>
                        <p class="text-xs text-red-500 mt-2">Error: ${error.message}</p>
                        <button onclick="window.navigate('POS')" class="mt-4 py-2 px-4 bg-red-600 text-white rounded-lg">KEMBALI KE KASIR</button>
                    </div>
                `;
            }

            contentArea.innerHTML = contentHtml;

            // Atur highlight navigasi
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('text-blue-600', 'font-bold'));
            const activeIndex = ['POS', 'PettyCash', 'Reports', 'Products'].indexOf(window.appState.currentPage);
            if (activeIndex !== -1) {
                document.querySelector(`.nav-btn:nth-child(${activeIndex + 1})`).classList.add('text-blue-600', 'font-bold');
            }
            
            // Fokuskan input barcode di halaman POS
            if (window.appState.currentPage === 'POS') {
                setTimeout(() => {
                    const posContent = document.getElementById('pos-content');
                    if (posContent && window.appState.settings.posBackground) {
                         posContent.style.backgroundImage = `url('${window.appState.settings.posBackground}')`;
                    }
                    document.getElementById('barcode-input')?.focus()
                }, 100);
            }
        };
        
        window.onload = () => {
            window.renderApp();
        };
    </script>
</body>
</html>
