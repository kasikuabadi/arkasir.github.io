<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ARKA shop - Arkasir</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #00875a;
      --secondary: #ffba00;
      --dark: #333;
      --light: #fff;
      --gray: #f5f5f5;
      --border: #ddd;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: #fafafa;
      padding-bottom: 140px;
    }

    .header {
      background-color: var(--primary);
      color: white;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .header .logo {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .search-bar {
      margin: 20px;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      display: flex;
      align-items: center;
      background-color: white;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }

    .search-bar input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 1rem;
      padding: 0 8px;
    }

    .info {
      padding: 0 20px;
      margin: 10px 0;
      font-weight: 500;
      color: var(--dark);
    }

    .btn {
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 0.95rem;
    }

    .btn-primary {
      background-color: var(--primary);
      color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn-warning {
      background-color: var(--secondary);
      color: #000;
    }

    .btn-danger {
      background-color: #e74c3c;
      color: white;
    }

    .product-list, .history-list, .stock-list, .settings-content, .report-content, .expense-content {
      padding: 0 20px;
    }

    .product-item, .history-item, .stock-item, .expense-item {
      background-color: white;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .product-info {
      flex: 1;
    }

    .product-name {
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 4px;
    }

    .product-price {
      color: var(--primary);
      font-weight: bold;
      font-size: 1.05rem;
      margin-bottom: 4px;
    }

    .product-stock, .history-date, .expense-date {
      color: green;
      font-size: 0.9rem;
    }

    .add-btn {
      background-color: var(--secondary);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 8px;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cart-footer {
      position: fixed;
      bottom: 60px;
      left: 0;
      right: 0;
      background-color: white;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 100;
    }

    .cart-total {
      font-size: 1.1rem;
      font-weight: bold;
      color: var(--dark);
    }

    .cart-total span {
      color: var(--primary);
      font-size: 1.2rem;
    }

    .nav-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: #333;
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: white;
      text-decoration: none;
      font-size: 0.8rem;
      width: 25%;
    }

    .nav-item.active {
      color: var(--secondary);
    }

    .nav-item i {
      font-size: 1.3rem;
      margin-bottom: 4px;
    }

    .hidden {
      display: none;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
    }

    .form-group input, .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
    }

    .history-item-info {
      flex: 1;
    }

    .history-total {
      color: var(--primary);
      font-weight: bold;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 200;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
    }

    .modal-footer {
      margin-top: 20px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* Struk */
    .receipt {
      width: 80mm;
      padding: 10px;
      font-family: monospace;
      font-size: 10pt;
      line-height: 1.2;
      border: 1px dashed #ccc;
      background: white;
      margin: 0 auto;
      box-sizing: border-box;
    }

    .receipt .header {
      text-align: center;
      margin-bottom: 10px;
    }

    .receipt .item {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
    }

    .receipt .total {
      font-weight: bold;
      margin-top: 10px;
      border-top: 1px solid #000;
      padding-top: 5px;
    }

    /* Scan Barcode */
    #scanner-container {
      position: relative;
      width: 100%;
      max-width: 500px;
      margin: 20px auto;
    }

    #scanner-video {
      width: 100%;
      border: 1px solid #ddd;
      border-radius: 8px;
    }

    #barcode-result {
      margin-top: 10px;
      padding: 10px;
      background: #f0f0f0;
      border-radius: 6px;
      font-weight: bold;
    }

    /* Chart Container */
    .chart-container {
      position: relative;
      height: 300px;
      margin: 20px 0;
    }

    /* Expense Form */
    .expense-form {
      background: white;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.08);
    }

    .expense-form .form-group {
      margin-bottom: 12px;
    }

    /* PWA Install Banner */
    #installBanner {
      position: fixed;
      bottom: 60px;
      left: 0;
      right: 0;
      background: var(--primary);
      color: white;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }

    #installBtn {
      background: white;
      color: var(--primary);
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="header">
    <div class="logo">
      <i class="fas fa-store"></i> <span id="shopNameDisplay">ARKA shop</span>
    </div>
    <div style="display: flex; align-items: center; gap: 8px;">
      <span id="cashierNameDisplay">Kasir: Budi</span>
      <span>ðŸ‘¤</span>
    </div>
  </div>

  <!-- Search Bar (Hanya di Transaksi) -->
  <div id="searchContainer" class="search-bar hidden">
    <i class="fas fa-search icon" style="color: #888;"></i>
    <input type="text" id="searchInput" placeholder="Cari Produk atau Scan Barcode..." />
  </div>

  <!-- Info -->
  <div class="info" id="infoText">Memuat data...</div>

  <!-- Tombol Reset (Hanya di Transaksi) -->
  <div id="resetBtnContainer" class="hidden" style="padding: 0 20px;">
    <button class="btn btn-primary" id="resetStockBtn">
      <i class="fas fa-sync"></i> Reset Stok Awal
    </button>
  </div>

  <!-- Section: Transaksi -->
  <div id="transaksi" class="section active">
    <div class="product-list" id="productList">
      <!-- Products loaded by JS -->
    </div>
  </div>

  <!-- Section: Riwayat -->
  <div id="riwayat" class="section">
    <div class="history-list" id="historyList">
      <!-- History loaded by JS -->
    </div>
  </div>

  <!-- Section: Stok -->
  <div id="stok" class="section">
    <div style="padding: 0 20px;">
      <button class="btn btn-warning" id="toggleStockFormBtn">
        <i class="fas fa-plus"></i> Tambah Produk
      </button>
    </div>
    <div class="stock-list" id="stockList">
      <!-- Stock list loaded by JS -->
    </div>
    <div id="stockFormContainer" class="settings-content hidden" style="padding: 20px;">
      <h3>Tambah / Edit Produk</h3>
      <div class="form-group">
        <label>Nama Produk</label>
        <input type="text" id="productName" placeholder="Contoh: Kopi Latte" />
      </div>
      <div class="form-group">
        <label>Harga (tanpa titik)</label>
        <input type="number" id="productPrice" placeholder="Contoh: 25000" />
      </div>
      <div class="form-group">
        <label>Stok Awal</label>
        <input type="number" id="productStock" placeholder="Contoh: 50" />
      </div>
      <button class="btn btn-warning" id="saveProductBtn">Simpan Produk</button>
      <button class="btn btn-danger" id="cancelProductBtn" style="margin-left: 8px;">Batal</button>
    </div>
  </div>

  <!-- Section: Laporan -->
  <div id="laporan" class="section">
    <div class="report-content" style="padding: 20px;">
      <h3>Laporan Penjualan</h3>
      <div style="margin-bottom: 20px;">
        <select id="reportPeriod" class="btn" style="width: auto; padding: 8px 16px;">
          <option value="daily">Harian</option>
          <option value="weekly">Mingguan</option>
          <option value="monthly">Bulanan</option>
        </select>
        <button class="btn btn-primary" id="generateReportBtn">Tampilkan</button>
      </div>
      <div class="chart-container">
        <canvas id="salesChart"></canvas>
      </div>
      <div id="reportSummary" style="margin-top: 20px; padding: 16px; background: #f9f9f9; border-radius: 8px;">
        <h4>Ringkasan</h4>
        <p>Total Transaksi: <span id="totalTransactions">0</span></p>
        <p>Pendapatan: <span id="totalRevenue">Rp 0</span></p>
        <p>Produk Terlaris: <span id="topProduct">-</span></p>
      </div>
    </div>
  </div>

  <!-- Section: Pengeluaran -->
  <div id="pengeluaran" class="section">
    <div class="expense-content" style="padding: 20px;">
      <h3>Pengeluaran Non-Produk</h3>
      <div class="expense-form">
        <div class="form-group">
          <label>Keterangan</label>
          <input type="text" id="expenseDesc" placeholder="Contoh: Beli printer baru" />
        </div>
        <div class="form-group">
          <label>Jumlah (Rp)</label>
          <input type="number" id="expenseAmount" placeholder="Contoh: 500000" />
        </div>
        <div class="form-group">
          <label>Tanggal</label>
          <input type="date" id="expenseDate" value="${new Date().toISOString().split('T')[0]}" />
        </div>
        <button class="btn btn-warning" id="addExpenseBtn">Tambah Pengeluaran</button>
      </div>
      <div class="history-list" id="expenseList">
        <!-- Expenses loaded by JS -->
      </div>
    </div>
  </div>

  <!-- Section: Pengaturan -->
  <div id="pengaturan" class="section">
    <div class="settings-content" style="padding: 20px;">
      <h3>Pengaturan Toko</h3>
      <div class="form-group">
        <label>Nama Toko</label>
        <input type="text" id="shopName" placeholder="Contoh: ARKA shop" />
      </div>
      <div class="form-group">
        <label>Nama Kasir</label>
        <input type="text" id="cashierName" placeholder="Contoh: Budi" />
      </div>
      <div class="form-group">
        <label>Upload Logo Toko</label>
        <input type="file" id="shopLogo" accept="image/*" />
      </div>
      <div class="form-group">
        <label>Alamat Toko</label>
        <textarea id="shopAddress" placeholder="Contoh: Jl. Raya No. 123, Jakarta"></textarea>
      </div>
      <button class="btn btn-primary" id="saveSettingsBtn">Simpan Pengaturan</button>
      <hr style="margin: 20px 0;" />
      <h3>Manajemen Data</h3>
      <button class="btn btn-primary" style="margin-top: 16px;" onclick="clearAllData()">
        <i class="fas fa-trash"></i> Hapus Semua Data
      </button>
      <button class="btn btn-warning" style="margin-top: 16px; margin-left: 8px;" onclick="exportData()">
        <i class="fas fa-download"></i> Ekspor Data
      </button>
      <button class="btn btn-primary" style="margin-top: 16px; margin-left: 8px;" onclick="importData()">
        <i class="fas fa-upload"></i> Impor Data
      </button>
    </div>
  </div>

  <!-- Cart Footer -->
  <div class="cart-footer hidden" id="cartFooter">
    <div class="cart-total" id="cartTotal">
      Keranjang: <span>Rp 0</span> (0 Item)
    </div>
    <button class="btn btn-warning" id="checkoutBtn">
      <i class="fas fa-money-bill-wave"></i> BAYAR
    </button>
  </div>

  <!-- Navigation Bar -->
  <div class="nav-bar">
    <a href="#" class="nav-item active" data-tab="transaksi">
      <i class="fas fa-keyboard"></i> Transaksi
    </a>
    <a href="#" class="nav-item" data-tab="riwayat">
      <i class="fas fa-history"></i> Riwayat
    </a>
    <a href="#" class="nav-item" data-tab="stok">
      <i class="fas fa-boxes"></i> Stok
    </a>
    <a href="#" class="nav-item" data-tab="laporan">
      <i class="fas fa-chart-line"></i> Laporan
    </a>
    <a href="#" class="nav-item" data-tab="pengeluaran">
      <i class="fas fa-wallet"></i> Pengeluaran
    </a>
    <a href="#" class="nav-item" data-tab="pengaturan">
      <i class="fas fa-cog"></i> Pengaturan
    </a>
  </div>

  <!-- Modal Konfirmasi Bayar -->
  <div id="paymentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Konfirmasi Pembayaran</h3>
        <button class="modal-close" onclick="closeModal('paymentModal')">&times;</button>
      </div>
      <div id="paymentDetails"></div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="closeModal('paymentModal')">Batal</button>
        <button class="btn btn-primary" id="confirmPaymentBtn">Bayar Sekarang</button>
      </div>
    </div>
  </div>

  <!-- Modal Cetak Struk -->
  <div id="printModal" class="modal">
    <div class="modal-content" style="max-width: 80mm; padding: 0; overflow: hidden;">
      <div class="modal-header">
        <h3>Struk Pembayaran</h3>
        <button class="modal-close" onclick="closeModal('printModal')">&times;</button>
      </div>
      <div id="receiptContent" class="receipt">
        <!-- Struk akan diisi oleh JS -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="closeModal('printModal')">Tutup</button>
        <button class="btn btn-primary" id="printReceiptBtn">Cetak</button>
      </div>
    </div>
  </div>

  <!-- Modal Ekspor -->
  <div id="exportModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Ekspor Data</h3>
        <button class="modal-close" onclick="closeModal('exportModal')">&times;</button>
      </div>
      <p>Data akan diekspor dalam format JSON.</p>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="closeModal('exportModal')">Batal</button>
        <button class="btn btn-primary" id="downloadExportBtn">Unduh File</button>
      </div>
    </div>
  </div>

  <!-- Modal Impor -->
  <div id="importModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Impor Data</h3>
        <button class="modal-close" onclick="closeModal('importModal')">&times;</button>
      </div>
      <p>Pilih file JSON yang telah diekspor sebelumnya.</p>
      <input type="file" id="importFile" accept=".json" style="margin: 16px 0;" />
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="closeModal('importModal')">Batal</button>
        <button class="btn btn-primary" id="confirmImportBtn">Impor</button>
      </div>
    </div>
  </div>

  <!-- Modal Scan Barcode -->
  <div id="scanModal" class="modal">
    <div class="modal-content" style="max-width: 500px; padding: 20px;">
      <div class="modal-header">
        <h3>Scan Barcode</h3>
        <button class="modal-close" onclick="closeModal('scanModal')">&times;</button>
      </div>
      <div id="scanner-container">
        <video id="scanner-video" autoplay playsinline></video>
        <div id="barcode-result">Menunggu scan...</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="closeModal('scanModal')">Tutup</button>
      </div>
    </div>
  </div>

  <!-- PWA Install Banner -->
  <div id="installBanner" class="hidden">
    <span>Install aplikasi ini untuk pengalaman lebih baik!</span>
    <button id="installBtn">Install</button>
  </div>

  <script>
    // Inisialisasi IndexedDB
    let db;

    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open("ArkasirDB", 2); // Versi 2

        request.onerror = () => reject("Gagal membuka database");
        request.onsuccess = (event) => {
          db = event.target.result;
          resolve();
        };

        request.onupgradeneeded = (event) => {
          const d = event.target.result;
          if (!d.objectStoreNames.contains('products')) {
            d.createObjectStore('products', { keyPath: 'id', autoIncrement: true });
          }
          if (!d.objectStoreNames.contains('cart')) {
            d.createObjectStore('cart');
          }
          if (!d.objectStoreNames.contains('history')) {
            d.createObjectStore('history', { keyPath: 'id', autoIncrement: true });
          }
          if (!d.objectStoreNames.contains('expenses')) {
            d.createObjectStore('expenses', { keyPath: 'id', autoIncrement: true });
          }
          if (!d.objectStoreNames.contains('settings')) {
            d.createObjectStore('settings', { keyPath: 'key' });
          }
        };
      });
    }

    // Helper: Get data from IndexedDB
    function getFromDB(storeName) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readonly');
        const store = transaction.objectStore(storeName);
        const request = store.getAll();

        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject("Gagal mengambil data");
      });
    }

    // Helper: Save data to IndexedDB
    function saveToDB(storeName, data) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        store.clear(); // Hapus semua data lama

        if (Array.isArray(data)) {
          data.forEach(item => store.add(item));
        } else {
          store.add(data);
        }

        transaction.oncomplete = () => resolve();
        transaction.onerror = () => reject("Gagal menyimpan data");
      });
    }

    // Format Rupiah
    function formatCurrency(num) {
      return new Intl.NumberFormat('id-ID').format(num);
    }

    // Data awal
    const initialProducts = [
      { id: 1, name: "Kopi Latte Dingin", price: 25000, stock: 50 },
      { id: 2, name: "Roti Tawar Gandum", price: 18000, stock: 15 },
      { id: 3, name: "Air Mineral 600ml", price: 5000, stock: 100 },
      { id: 4, name: "Teh Hijau Botol", price: 8500, stock: 30 },
      { id: 5, name: "Chocolatos", price: 3000, stock: 80 },
      { id: 6, name: "Susu UHT Coklat", price: 7000, stock: 40 },
      { id: 7, name: "Keripik Kentang", price: 12000, stock: 25 }
    ];

    // Global state
    let products = [];
    let cart = [];
    let history = [];
    let expenses = [];
    let settings = {
      shopName: "ARKA shop",
      cashierName: "Budi",
      shopLogo: "",
      shopAddress: ""
    };

    // Load data dari IndexedDB
    async function loadData() {
      try {
        await initDB();
        products = await getFromDB('products');
        cart = await getFromDB('cart');
        history = await getFromDB('history');
        expenses = await getFromDB('expenses');
        const savedSettings = await getFromDB('settings');
        if (savedSettings && savedSettings.length > 0) {
          settings = savedSettings[0];
        }

        if (products.length === 0) {
          products = initialProducts.map(p => ({ ...p }));
          await saveToDB('products', products);
        }

        if (!cart || cart.length === 0) {
          cart = [];
          await saveToDB('cart', cart);
        }

        if (!history || history.length === 0) {
          history = [];
          await saveToDB('history', history);
        }

        if (!expenses || expenses.length === 0) {
          expenses = [];
          await saveToDB('expenses', expenses);
        }

        updateShopInfo();
        renderProducts();
        updateCartDisplay();
      } catch (err) {
        console.error(err);
        alert("Gagal memuat data. Gunakan localStorage sebagai fallback.");
        loadFromLocalStorage();
      }
    }

    // Fallback ke localStorage jika IndexedDB gagal
    function loadFromLocalStorage() {
      products = JSON.parse(localStorage.getItem('arkasir_products')) || initialProducts;
      cart = JSON.parse(localStorage.getItem('arkasir_cart')) || [];
      history = JSON.parse(localStorage.getItem('arkasir_history')) || [];
      expenses = JSON.parse(localStorage.getItem('arkasir_expenses')) || [];
      settings = JSON.parse(localStorage.getItem('arkasir_settings')) || {
        shopName: "ARKA shop",
        cashierName: "Budi",
        shopLogo: "",
        shopAddress: ""
      };
      updateShopInfo();
      renderProducts();
      updateCartDisplay();
    }

    // Simpan data ke IndexedDB + localStorage (fallback)
    async function saveData() {
      try {
        await saveToDB('products', products);
        await saveToDB('cart', cart);
        await saveToDB('history', history);
        await saveToDB('expenses', expenses);
        await saveToDB('settings', [settings]);
      } catch (err) {
        console.error(err);
        // Simpan ke localStorage sebagai fallback
        localStorage.setItem('arkasir_products', JSON.stringify(products));
        localStorage.setItem('arkasir_cart', JSON.stringify(cart));
        localStorage.setItem('arkasir_history', JSON.stringify(history));
        localStorage.setItem('arkasir_expenses', JSON.stringify(expenses));
        localStorage.setItem('arkasir_settings', JSON.stringify(settings));
      }
    }

    // Update tampilan nama toko & kasir
    function updateShopInfo() {
      document.getElementById('shopNameDisplay').textContent = settings.shopName;
      document.getElementById('cashierNameDisplay').textContent = `Kasir: ${settings.cashierName}`;
    }

    // Navigation
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', function(e) {
        e.preventDefault();
        const tab = this.dataset.tab;
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(tab).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        this.classList.add('active');

        if (tab === 'transaksi') {
          document.getElementById('searchContainer').classList.remove('hidden');
          document.getElementById('resetBtnContainer').classList.remove('hidden');
          document.getElementById('cartFooter').classList.remove('hidden');
          renderProducts();
        } else {
          document.getElementById('searchContainer').classList.add('hidden');
          document.getElementById('resetBtnContainer').classList.add('hidden');
          document.getElementById('cartFooter').classList.add('hidden');
        }

        if (tab === 'riwayat') {
          renderHistory();
        } else if (tab === 'stok') {
          renderStock();
        } else if (tab === 'laporan') {
          generateReport();
        } else if (tab === 'pengeluaran') {
          renderExpenses();
        }
      });
    });

    // Render Produk (Transaksi)
    function renderProducts(query = '') {
      const list = document.getElementById('productList');
      const filtered = query
        ? products.filter(p => p.name.toLowerCase().includes(query.toLowerCase()) && p.stock > 0)
        : products.filter(p => p.stock > 0);

      list.innerHTML = '';
      if (filtered.length === 0) {
        list.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">Tidak ada produk tersedia.</div>';
        document.getElementById('infoText').textContent = 'Stok habis atau tidak ditemukan.';
        return;
      }

      document.getElementById('infoText').textContent = `Tersedia ${filtered.length} produk.`;

      filtered.forEach(product => {
        const div = document.createElement('div');
        div.className = 'product-item';
        div.innerHTML = `
          <div class="product-info">
            <div class="product-name">${product.name}</div>
            <div class="product-price">Rp ${formatCurrency(product.price)}</div>
            <div class="product-stock">Stok: ${product.stock}</div>
          </div>
          <button class="add-btn" data-id="${product.id}">+</button>
        `;
        list.appendChild(div);
      });

      document.querySelectorAll('.add-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = parseInt(btn.dataset.id);
          addToCart(id);
        });
      });
    }

    // Tambah ke keranjang
    function addToCart(productId) {
      const product = products.find(p => p.id === productId);
      if (!product || product.stock <= 0) {
        alert("Stok habis!");
        return;
      }

      const cartItem = cart.find(item => item.id === productId);
      if (cartItem) {
        cartItem.quantity += 1;
      } else {
        cart.push({
          id: product.id,
          name: product.name,
          price: product.price,
          quantity: 1
        });
      }
      product.stock -= 1;
      saveData();
      updateCartDisplay();
      renderProducts();
    }

    // Update tampilan keranjang
    function updateCartDisplay() {
      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
      const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const el = document.getElementById('cartTotal');
      el.innerHTML = `Keranjang: <span>Rp ${formatCurrency(totalPrice)}</span> (${totalItems} Item)`;
    }

    // Pembayaran
    document.getElementById('checkoutBtn').addEventListener('click', () => {
      if (cart.length === 0) {
        alert("Keranjang kosong!");
        return;
      }

      const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const details = cart.map(item => `${item.name} x${item.quantity} = Rp ${formatCurrency(item.price * item.quantity)}`).join('<br>');
      document.getElementById('paymentDetails').innerHTML = `
        <strong>Total: Rp ${formatCurrency(total)}</strong><br><br>
        Detail:<br>
        ${details}
      `;
      document.getElementById('paymentModal').style.display = 'flex';
    });

    document.getElementById('confirmPaymentBtn').addEventListener('click', () => {
      const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const transaction = {
        id: Date.now(),
        items: [...cart],
        total: total,
        date: new Date().toLocaleString('id-ID')
      };
      history.unshift(transaction);
      cart = [];
      saveData();
      updateCartDisplay();
      renderProducts();
      closeModal('paymentModal');
      showPrintReceipt(transaction);
      alert("Pembayaran berhasil! Terima kasih.");
    });

    // Tampilkan struk setelah bayar
    function showPrintReceipt(transaction) {
      const receipt = document.getElementById('receiptContent');
      const now = new Date().toLocaleString('id-ID');
      let itemsHTML = '';
      transaction.items.forEach(item => {
        itemsHTML += `<div class="item"><span>${item.name}</span><span>Rp ${formatCurrency(item.price * item.quantity)}</span></div>`;
      });

      receipt.innerHTML = `
        <div class="header">
          <strong>${settings.shopName}</strong><br>
          ${settings.shopAddress || 'Alamat tidak diisi'}<br>
          ${now}<br>
          Kasir: ${settings.cashierName}<br>
          Transaksi #${transaction.id}
        </div>
        <hr>
        ${itemsHTML}
        <div class="total">
          Total: Rp ${formatCurrency(transaction.total)}
        </div>
        <div style="text-align: center; margin-top: 20px;">
          Terima kasih atas kunjungan Anda!
        </div>
      `;

      document.getElementById('printModal').style.display = 'flex';
    }

    // Cetak struk
    document.getElementById('printReceiptBtn').addEventListener('click', () => {
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
        <head>
          <title>Struk Pembayaran</title>
          <style>
            body { font-family: monospace; font-size: 10pt; line-height: 1.2; margin: 0; padding: 10px; }
            .receipt { width: 80mm; padding: 10px; }
            .header { text-align: center; margin-bottom: 10px; }
            .item { display: flex; justify-content: space-between; margin: 4px 0; }
            .total { font-weight: bold; margin-top: 10px; border-top: 1px solid #000; padding-top: 5px; }
          </style>
        </head>
        <body>
          ${document.getElementById('receiptContent').outerHTML}
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
      printWindow.close();
    });

    // Reset stok
    document.getElementById('resetStockBtn').addEventListener('click', () => {
      if (confirm("Yakin reset stok ke kondisi awal?")) {
        products = JSON.parse(JSON.stringify(initialProducts));
        cart = [];
        saveData();
        renderProducts();
        updateCartDisplay();
        alert("Stok berhasil direset.");
      }
    });

    // Riwayat
    function renderHistory() {
      const list = document.getElementById('historyList');
      list.innerHTML = '';
      if (history.length === 0) {
        list.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">Belum ada transaksi.</div>';
        return;
      }

      history.forEach(trans => {
        const items = trans.items.map(i => `${i.name} (x${i.quantity})`).join(', ');
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
          <div class="history-item-info">
            <div><strong>Transaksi #${trans.id}</strong></div>
            <div class="history-date">${trans.date}</div>
            <div style="font-size: 0.9rem; margin-top: 4px;">${items}</div>
          </div>
          <div class="history-total">Rp ${formatCurrency(trans.total)}</div>
        `;
        list.appendChild(div);
      });
    }

    // Stok (Edit & Hapus)
    function renderStock() {
      const list = document.getElementById('stockList');
      list.innerHTML = '';
      products.forEach(product => {
        const div = document.createElement('div');
        div.className = 'stock-item';
        div.innerHTML = `
          <div class="product-info">
            <div class="product-name">${product.name}</div>
            <div class="product-price">Rp ${formatCurrency(product.price)}</div>
            <div class="product-stock">Stok: ${product.stock}</div>
          </div>
          <div>
            <button class="btn btn-warning" style="padding: 6px 10px; font-size: 0.9rem;" data-id="${product.id}" onclick="editProduct(${product.id})">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-danger" style="padding: 6px 10px; font-size: 0.9rem; margin-left: 5px;" data-id="${product.id}" onclick="deleteProduct(${product.id})">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        list.appendChild(div);
      });
    }

    window.editProduct = function(id) {
      const product = products.find(p => p.id === id);
      if (!product) return;
      document.getElementById('productName').value = product.name;
      document.getElementById('productPrice').value = product.price;
      document.getElementById('productStock').value = product.stock;
      document.getElementById('stockFormContainer').classList.remove('hidden');
      window.editingProductId = id;
    };

    window.deleteProduct = function(id) {
      if (confirm("Hapus produk ini?")) {
        products = products.filter(p => p.id !== id);
        saveData();
        renderStock();
        renderProducts();
      }
    };

    // Toggle form tambah produk
    document.getElementById('toggleStockFormBtn').addEventListener('click', () => {
      document.getElementById('stockFormContainer').classList.remove('hidden');
      document.getElementById('productName').value = '';
      document.getElementById('productPrice').value = '';
      document.getElementById('productStock').value = '';
      delete window.editingProductId;
    });

    // Simpan produk (tambah/edit)
    document.getElementById('saveProductBtn').addEventListener('click', () => {
      const name = document.getElementById('productName').value.trim();
      const price = parseInt(document.getElementById('productPrice').value);
      const stock = parseInt(document.getElementById('productStock').value);

      if (!name || isNaN(price) || price <= 0 || isNaN(stock) || stock < 0) {
        alert("Harap isi semua data dengan benar.");
        return;
      }

      if (window.editingProductId) {
        const product = products.find(p => p.id === window.editingProductId);
        if (product) {
          product.name = name;
          product.price = price;
          product.stock = stock;
        }
      } else {
        const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
        products.push({ id: newId, name, price, stock });
      }

      saveData();
      document.getElementById('stockFormContainer').classList.add('hidden');
      renderStock();
      renderProducts();
    });

    document.getElementById('cancelProductBtn').addEventListener('click', () => {
      document.getElementById('stockFormContainer').classList.add('hidden');
    });

    // Pencarian
    document.getElementById('searchInput').addEventListener('input', (e) => {
      renderProducts(e.target.value);
    });

    // Hapus semua data
    window.clearAllData = function() {
      if (confirm("Hapus SEMUA data? Tindakan ini tidak bisa dikembalikan!")) {
        products = JSON.parse(JSON.stringify(initialProducts));
        cart = [];
        history = [];
        expenses = [];
        settings = {
          shopName: "ARKA shop",
          cashierName: "Budi",
          shopLogo: "",
          shopAddress: ""
        };
        saveData();
        renderProducts();
        updateCartDisplay();
        renderHistory();
        renderStock();
        renderExpenses();
        updateShopInfo();
        alert("Semua data telah dihapus.");
      }
    };

    // Ekspor data
    window.exportData = function() {
      const data = {
        products,
        cart,
        history,
        expenses,
        settings,
        exportDate: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `arkasir_backup_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };

    // Impor data
    window.importData = function() {
      document.getElementById('importModal').style.display = 'flex';
    };

    document.getElementById('confirmImportBtn').addEventListener('click', () => {
      const fileInput = document.getElementById('importFile');
      const file = fileInput.files[0];
      if (!file) {
        alert("Pilih file terlebih dahulu.");
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          products = data.products || [];
          cart = data.cart || [];
          history = data.history || [];
          expenses = data.expenses || [];
          settings = data.settings || {
            shopName: "ARKA shop",
            cashierName: "Budi",
            shopLogo: "",
            shopAddress: ""
          };
          saveData();
          renderProducts();
          updateCartDisplay();
          renderHistory();
          renderStock();
          renderExpenses();
          updateShopInfo();
          closeModal('importModal');
          fileInput.value = '';
          alert("Data berhasil diimpor.");
        } catch (err) {
          alert("Gagal mengimpor data. Pastikan file JSON valid.");
        }
      };
      reader.readAsText(file);
    });

    // Scan Barcode
    let scannerActive = false;
    let videoStream = null;

    window.startScanner = function() {
      if (scannerActive) return;

      const video = document.getElementById('scanner-video');
      const resultDiv = document.getElementById('barcode-result');

      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => {
          videoStream = stream;
          video.srcObject = stream;
          scannerActive = true;
          resultDiv.textContent = "Scanning...";

          // Gunakan QuaggaJS (harus dimuat dari CDN)
          if (typeof Quagga === 'undefined') {
            alert("QuaggaJS belum dimuat. Silakan pastikan koneksi internet.");
            return;
          }

          Quagga.init({
            inputStream: {
              name: "Live",
              type: "LiveStream",
              target: video,
              constraints: {
                width: 640,
                height: 480,
                facingMode: "environment"
              }
            },
            decoder: {
              readers: ["code_128_reader", "ean_reader", "ean_8_reader", "upc_reader"]
            }
          }, function(err) {
            if (err) {
              console.error(err);
              resultDiv.textContent = "Error: " + err.message;
              return;
            }
            Quagga.start();
          });

          Quagga.onDetected(function(result) {
            const code = result.codeResult.code;
            resultDiv.textContent = `Barcode terdeteksi: ${code}`;
            Quagga.stop();

            // Cari produk berdasarkan barcode (misalnya, simulasikan dengan ID produk)
            const product = products.find(p => p.id == code); // Misal: barcode = ID produk
            if (product) {
              addToCart(product.id);
              resultDiv.textContent = `Produk ditemukan: ${product.name}`;
            } else {
              resultDiv.textContent = "Produk tidak ditemukan.";
            }

            setTimeout(() => {
              if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
              }
              scannerActive = false;
              closeModal('scanModal');
            }, 3000);
          });

        })
        .catch(err => {
          console.error("Gagal akses kamera:", err);
          resultDiv.textContent = "Gagal akses kamera. Izinkan akses kamera.";
        });
    };

    document.getElementById('scanModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal('scanModal');
      }
    });

    // Scan button in header
    document.querySelector('.header .logo').addEventListener('click', () => {
      document.getElementById('scanModal').style.display = 'flex';
      startScanner();
    });

    // Laporan
    function generateReport() {
      const period = document.getElementById('reportPeriod').value;
      const now = new Date();
      let startDate, endDate;

      if (period === 'daily') {
        startDate = new Date(now.setHours(0,0,0,0));
        endDate = new Date(now.setHours(23,59,59,999));
      } else if (period === 'weekly') {
        const day = now.getDay();
        startDate = new Date(now);
        startDate.setDate(now.getDate() - day);
        startDate.setHours(0,0,0,0);
        endDate = new Date(startDate);
        endDate.setDate(endDate.getDate() + 6);
        endDate.setHours(23,59,59,999);
      } else if (period === 'monthly') {
        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        endDate.setHours(23,59,59,999);
      }

      const filtered = history.filter(h => {
        const date = new Date(h.date);
        return date >= startDate && date <= endDate;
      });

      const totalTransactions = filtered.length;
      const totalRevenue = filtered.reduce((sum, h) => sum + h.total, 0);

      // Produk terlaris
      const productSales = {};
      filtered.forEach(h => {
        h.items.forEach(item => {
          if (!productSales[item.name]) productSales[item.name] = 0;
          productSales[item.name] += item.quantity;
        });
      });

      let topProduct = "-";
      let maxQty = 0;
      for (const [name, qty] of Object.entries(productSales)) {
        if (qty > maxQty) {
          maxQty = qty;
          topProduct = name;
        }
      }

      document.getElementById('totalTransactions').textContent = totalTransactions;
      document.getElementById('totalRevenue').textContent = `Rp ${formatCurrency(totalRevenue)}`;
      document.getElementById('topProduct').textContent = topProduct;

      // Render chart
      const ctx = document.getElementById('salesChart').getContext('2d');
      if (window.salesChart) {
        window.salesChart.destroy();
      }

      const labels = Object.keys(productSales);
      const data = Object.values(productSales);

      window.salesChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Jumlah Terjual',
            data: data,
            backgroundColor: 'rgba(0, 135, 90, 0.7)',
            borderColor: 'rgba(0, 135, 90, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.raw} unit`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    document.getElementById('generateReportBtn').addEventListener('click', generateReport);

    // Pengeluaran
    function renderExpenses() {
      const list = document.getElementById('expenseList');
      list.innerHTML = '';
      if (expenses.length === 0) {
        list.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">Belum ada pengeluaran.</div>';
        return;
      }

      expenses.forEach(expense => {
        const div = document.createElement('div');
        div.className = 'expense-item';
        div.innerHTML = `
          <div class="product-info">
            <div class="product-name">${expense.description}</div>
            <div class="product-price">Rp ${formatCurrency(expense.amount)}</div>
            <div class="expense-date">${expense.date}</div>
          </div>
          <button class="btn btn-danger" style="padding: 6px 10px; font-size: 0.9rem;" data-id="${expense.id}" onclick="deleteExpense(${expense.id})">
            <i class="fas fa-trash"></i>
          </button>
        `;
        list.appendChild(div);
      });
    }

    document.getElementById('addExpenseBtn').addEventListener('click', () => {
      const desc = document.getElementById('expenseDesc').value.trim();
      const amount = parseInt(document.getElementById('expenseAmount').value);
      const date = document.getElementById('expenseDate').value;

      if (!desc || isNaN(amount) || amount <= 0 || !date) {
        alert("Harap isi semua data dengan benar.");
        return;
      }

      const newExpense = {
        id: Date.now(),
        description: desc,
        amount: amount,
        date: date
      };

      expenses.push(newExpense);
      saveData();
      renderExpenses();
      document.getElementById('expenseDesc').value = '';
      document.getElementById('expenseAmount').value = '';
      document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
    });

    window.deleteExpense = function(id) {
      if (confirm("Hapus pengeluaran ini?")) {
        expenses = expenses.filter(e => e.id !== id);
        saveData();
        renderExpenses();
      }
    };

    // Pengaturan
    document.getElementById('saveSettingsBtn').addEventListener('click', () => {
      const shopName = document.getElementById('shopName').value.trim();
      const cashierName = document.getElementById('cashierName').value.trim();
      const shopAddress = document.getElementById('shopAddress').value.trim();

      if (!shopName || !cashierName) {
        alert("Nama toko dan kasir wajib diisi.");
        return;
      }

      settings.shopName = shopName;
      settings.cashierName = cashierName;
      settings.shopAddress = shopAddress;

      // Handle logo upload
      const fileInput = document.getElementById('shopLogo');
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
          settings.shopLogo = e.target.result;
          saveData();
          updateShopInfo();
          alert("Pengaturan disimpan.");
        };
        reader.readAsDataURL(file);
      } else {
        saveData();
        updateShopInfo();
        alert("Pengaturan disimpan.");
      }
    });

    // Modal helper
    function closeModal(id) {
      document.getElementById(id).style.display = 'none';
      if (id === 'scanModal' && videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
        scannerActive = false;
      }
    }

    // PWA Installation
    let deferredPrompt;

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('installBanner').classList.remove('hidden');
    });

    document.getElementById('installBtn').addEventListener('click', () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(choiceResult => {
          if (choiceResult.outcome === 'accepted') {
            console.log('User accepted the install prompt');
          }
          deferredPrompt = null;
          document.getElementById('installBanner').classList.add('hidden');
        });
      }
    });

    // Init
    document.addEventListener('DOMContentLoaded', loadData);
  </script>

  <!-- Load QuaggaJS for Barcode Scanning -->
  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

</body>
</html>

